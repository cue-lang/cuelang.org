<!doctype html>
<html lang="en" dir="ltr" class="no-js">
    <head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Source: https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial In this tutorial we show how to convert Kubernetes configuration files for â€¦">
<meta name="generator" content="Hugo 0.147.5">

<meta name="robots" content="noindex, nofollow">

<link rel="canonical" href="https://cuelang.org/docs/draft/cbe-003_kubernetes_tutorial/" />
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/webmanifest.json">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#232a68">
<meta name="msapplication-TileColor" content="#232a68">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#232a68">

<title>CUE By Example - Controlling Kubernetes with CUE | CUE</title><meta property="og:url" content="/docs/draft/cbe-003_kubernetes_tutorial/">
  <meta property="og:site_name" content="CUE">
  <meta property="og:title" content="CUE By Example - Controlling Kubernetes with CUE">
  <meta property="og:description" content="Source: https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial In this tutorial we show how to convert Kubernetes configuration files for a collection of microservices.
The configuration files are scrubbed and renamed versions of real-life configuration files. The files are organized in a directory hierarchy grouping related services in subdirectories. This is a common pattern. The cue tooling has been optimized for this use case.
In this tutorial we will address the following topics:">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:modified_time" content="2025-05-22T15:12:54+01:00">
    <meta property="og:image" content="/img/social.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/img/social.png">
  <meta name="twitter:title" content="CUE By Example - Controlling Kubernetes with CUE">
  <meta name="twitter:description" content="Source: https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial In this tutorial we show how to convert Kubernetes configuration files for a collection of microservices.
The configuration files are scrubbed and renamed versions of real-life configuration files. The files are organized in a directory hierarchy grouping related services in subdirectories. This is a common pattern. The cue tooling has been optimized for this use case.
In this tutorial we will address the following topics:">





<link rel="preload" href="/scss/main.min.8351627014ac2bf7396348f13a7d9959c01f0c9eee800e29af55ada087dad866.css" as="style">
<link href="/scss/main.min.8351627014ac2bf7396348f13a7d9959c01f0c9eee800e29af55ada087dad866.css" rel="stylesheet" integrity="">



<link rel="preload" href="/fonts/inter/regular.woff2" as="font" crossorigin="anonymous">
<link rel="preload" href="/fonts/inter/500.woff2" as="font" crossorigin="anonymous">
<link rel="preload" href="/fonts/inter/700.woff2" as="font" crossorigin="anonymous">



<script>(()=>{document.documentElement.classList.remove("no-js"),document.documentElement.classList.add("js")})()</script>
</head>
    <body itemscope itemtype="https://schema.org/WebPage">
        <meta itemprop="name" content="CUE By Example - Controlling Kubernetes with CUE">
<meta itemprop="description" content=" Source: https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial In this tutorial we show how to convert Kubernetes configuration files for a collection of microservices.
The configuration files are scrubbed and renamed versions of real-life configuration files. The files are organized in a directory hierarchy grouping related services in subdirectories. This is a common pattern. The cue tooling has been optimized for this use case.
In this tutorial we will address the following topics:
">

    
        <meta itemprop="dateModified" content="2025-05-22T15:12:54+01:00" >
    
            
        <meta itemprop="image" content="/img/social.png"/>
            
    <meta itemprop="keywords" content="" />

        <a id="skip-nav" class="skip-link" href="#site-main" target="_self">Skip to content</a>

        <div class="site">
            <header id="site-header" class="site__header">
                

<div class="header header--wide" data-header>
    <div class="header__container">
        <div class="header__background"></div>

        <div class="header__branding">
            <a href="/" class="header__logo" rel="home">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><path class="logo__letters" d="M39.555 50.355c-6.853.0-11.907 5.133-11.907 13.602s5.027 13.602 11.907 13.602c5.818.0 10.073-3.648 10.94-8.883l-4.034-.012c-.686 3.389-3.532 5.252-6.88 5.252-4.541.0-7.968-3.533-7.968-9.957s3.414-9.955 7.979-9.955c3.373.0 6.207 1.902 6.865 5.328l.004-.002h4.033c-.906-5.664-5.34-8.975-10.94-8.975zm38.748.362-.002.004h.002zm0 .004v26.478H96.07v-3.44H82.297v-8.105h12.752V62.23H82.297V54.16h13.617v-3.44zm-24.823.0v17.521c0 5.974 4.651 9.4 10.51 9.4 5.86.0 10.528-3.426 10.528-9.4V50.721h-3.995v17.457c0 3.711-2.985 5.793-6.529 5.793s-6.517-2.082-6.517-5.793V50.72z"/><path class="logo__inner" d="M64 9.586C33.947 9.586 9.586 33.947 9.586 64S33.947 118.414 64 118.414 118.414 94.053 118.414 64 94.05 9.586 64 9.586zm0 105.973c-28.476.0-51.562-23.086-51.562-51.562S35.524 12.438 64 12.438 115.562 35.524 115.562 64 92.476 115.562 64 115.562z"/><path class="logo__outer" d="M64 0C28.653.0.0 28.653.0 64s28.653 64 64 64 64-28.653 64-64S99.347.0 64 0zm0 121.843C32.054 121.843 6.157 95.946 6.157 64S32.054 6.157 64 6.157 121.843 32.054 121.843 64 95.946 121.843 64 121.843z"/></svg>
                <span>Homepage of CUE</span>
            </a>
        </div>

        <div class="header__main">
            <nav class="nav nav--main" aria-label="Main menu">
                <ul class="nav__list">
                    
                        <li class="nav__item"><a class="nav__link"
                               href="/docs/"><span class="nav__text">Documentation</span></a>
                        </li>
                    
                        <li class="nav__item"><a class="nav__link"
                               href="/play/"><span class="nav__text">Play</span></a>
                        </li>
                    
                        <li class="nav__item"><a class="nav__link"
                               href="/community/"><span class="nav__text">Community</span></a>
                        </li>
                    
                </ul>
            </nav>
        </div>

        <div class="header__secondary">
            <div class="header__icons">
                <nav class="nav nav--social" aria-label="Social">
                    <ul class="nav__list"><li class="nav__item"><a class="nav__link"
                                   href="https://github.com/cue-lang/cue" target="_blank">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--github"></use>
</svg>

                                    <span class="nav__text">GitHub</span>
                                </a>
                            </li><li class="nav__item"><a class="nav__link"
                                   href="/s/slack">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--slack"></use>
</svg>

                                    <span class="nav__text">Slack</span>
                                </a>
                            </li><li class="nav__item"><a class="nav__link"
                                   href="/s/discord">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-discord"></use>
</svg>

                                    <span class="nav__text">Discord</span>
                                </a>
                            </li><li class="nav__item"><a class="nav__link"
                                   href="https://twitter.com/cue_lang" target="_blank">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-x"></use>
</svg>

                                    <span class="nav__text">X (Twitter)</span>
                                </a>
                            </li><li class="nav__item"><a class="nav__link"
                                   href="https://bsky.app/profile/cuelang.org" target="_blank">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-bluesky"></use>
</svg>

                                    <span class="nav__text">Bluesky</span>
                                </a>
                            </li><li class="nav__item"><a class="nav__link"
                                   href="https://www.youtube.com/@cuelang/videos" target="_blank">
                                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-youtube"></use>
</svg>

                                    <span class="nav__text">YouTube</span>
                                </a>
                            </li></ul>
                </nav>
            </div>

            <div class="header__cta"><a class="button button--skinny"
                       href="/docs/introduction/installation/"><span class="button__text">Install</span>



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--download"></use>
</svg>
</a></div>

            <div class="header__search" data-menu>
                <a href="/search" class="button button--icon button--white-simple" rel="search" data-menu-dropdown="header-dropdown-search">



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--search"></use>
</svg>
<span>Search</span>
                </a>

                <div class="header__dropdown header__dropdown--search" data-menu-dropdown-target="header-dropdown-search">
                    <p class="header__search-title">What are you looking for?</p>





<div data-search-autocomplete="menu"
     data-searchbar-size="small"
     data-searchbar-placeholder=""
>
    <div id="autocomplete-menu"></div>
</div>
</div>
            </div>

            <div class="header__toggle">
                <button class="button button--outline" data-drawer-toggle="menu" aria-haspopup="menu" aria-expanded="false" aria-controls="mobile-menu">
                    <span class="button__text">Menu</span>



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--menu"></use>
</svg>
</button>
            </div>
        </div>
    </div>
</div>

            </header>

            <main id="site-main" class="site__content" itemprop="mainContentOfPage">
                

    <div class="docs" data-docs>
        <div class="docs__main">
            <nav class="breadcrumb" aria-label="breadcrumb">
    <ol class="breadcrumb__list">
    

    
    

    
        <li class="breadcrumb__item"><a class="breadcrumb__link" href="/docs/draft/">Drafts</a></li>
    
    

    
        <li class="breadcrumb__item" aria-current="page"><h1 class="breadcrumb__text">CUE By Example - Controlling Kubernetes with CUE</h1></li>
    
    </ol>
</nav>


            <article class="article article--docs" itemscope itemtype="https://schema.org/TechArticle">
                <meta itemprop="articleBody" content="




    

Source: https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial


In this tutorial we show how to convert Kubernetes configuration files
for a collection of microservices.
The configuration files are scrubbed and renamed versions of
real-life configuration files.
The files are organized in a directory hierarchy grouping related services
in subdirectories.
This is a common pattern.
The cue tooling has been optimized for this use case.
In this tutorial we will address the following topics:

convert the given YAML files to CUE
hoist common patterns to parent directories
use the tooling to rewrite CUE files to drop unnecessary fields
repeat from step 2 for different subdirectories
define commands to operate on the configuration
extract CUE templates directly from Kubernetes Go source
manually tailor the configuration
map a Kubernetes configuration to docker-compose (TODO)


    




    

The given data set
The data set is based on a real-life case, using different names for the
services.
All the inconsistencies of the real setup are replicated in the files
to get a realistic impression of how a conversion to CUE would behave
in practice.
The given YAML files are ordered in following directory
(you can use find if you don&rsquo;t have tree):

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ find ./original -type f | sort
./original/services/frontend/bartender/kube.yaml
./original/services/frontend/breaddispatcher/kube.yaml
./original/services/frontend/host/kube.yaml
./original/services/frontend/maitred/kube.yaml
./original/services/frontend/valeter/kube.yaml
...

Each subdirectory contains related microservices that often share similar
characteristics and configurations.
The configurations include a large variety of Kubernetes objects, including
services, deployments, config maps,
a daemon set, a stateful set, and a cron job.
The result of the first tutorial is in the quick, for &ldquo;quick and dirty&rdquo;
directory.
A manually optimized configuration can be found int manual
directory.

    




    

Importing existing configuration
We first make a copy of the data directory.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cp -a original tmp
$ cd tmp

We initialize a module so that we can treat all our configuration files
in the subdirectories as part of one package.
We do that later by giving all the same package name.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue mod init k8s.example

Creating a module also allows our packages import external packages.
We initialize a Go module so that later we can resolve the
k8s.io/api/apps/v1 Go package dependency:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ go mod init k8s.example
go: creating new go.mod: module k8s.example
go: to add module requirements and sums:
	go mod tidy

Let&rsquo;s try to use the cue import command to convert the given YAML files
into CUE.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cd services


                Copy code
                
                    Copied!
                
            $ cd services

Since we have multiple packages and files, we need to specify the package to
which they should belong.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue import ./... -p kube
path, list, or files flag needed to handle multiple objects in file ./services/frontend/bartender/kube.yaml

Many of the files contain more than one Kubernetes object.
Moreover, we are creating a single configuration that contains all objects
from all files.
We need to organize all Kubernetes objects such that each is individually
identifiable within the single configuration.
We do so by defining a different struct for each type putting each object
in this respective struct keyed by its name.
This allows objects of different types to share the same name,
just as is allowed by Kubernetes.
To accomplish this, we tell cue to put each object in the configuration
tree at the path with the &ldquo;kind&rdquo; as first element and &ldquo;name&rdquo; as second.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue import ./... -p kube -l &#39;strings.ToCamel(kind)&#39; -l metadata.name -f

The added -l flag defines the labels for each object, based on values from
each object, using the usual CUE syntax for field labels.
In this case, we use a camelcase variant of the kind field of each object and
use the name field of the metadata section as the name for each object.
We also added the -f flag to overwrite the few files that succeeded before.
Let&rsquo;s see what happened:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ find . -type f | sort
./frontend/bartender/kube.cue
./frontend/bartender/kube.yaml
./frontend/breaddispatcher/kube.cue
./frontend/breaddispatcher/kube.yaml
./frontend/host/kube.cue
...

Each of the YAML files is converted to corresponding CUE files.
Comments of the YAML files are preserved.
The result is not fully pleasing, though.
Take a look at mon/prometheus/configmap.cue.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ head mon/prometheus/configmap.cue
package kube

configMap: prometheus: {
	apiVersion: &#34;v1&#34;
	kind:       &#34;ConfigMap&#34;
	metadata: name: &#34;prometheus&#34;
	data: {
		&#34;alert.rules&#34;: &#34;&#34;&#34;
			groups:
			- name: rules.yaml

The configuration file still contains YAML embedded in a string value of one
of the fields.
The original YAML file might have looked like it was all structured data, but
the majority of it was a string containing, hopefully, valid YAML.
The -R option attempts to detect structured YAML or JSON strings embedded
in the configuration files and then converts these recursively.


            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue import ./... -p kube -l &#39;strings.ToCamel(kind)&#39; -l metadata.name -f -R

Now the file looks like:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ head mon/prometheus/configmap.cue
package kube

import &#34;encoding/yaml&#34;

configMap: prometheus: {
	apiVersion: &#34;v1&#34;
	kind:       &#34;ConfigMap&#34;
	metadata: name: &#34;prometheus&#34;
	data: {
		&#34;alert.rules&#34;: yaml.Marshal(_cue_alert_rules)

That looks better!
The resulting configuration file replaces the original embedded string
with a call to yaml.Marshal converting a structured CUE source to
a string with an equivalent YAML file.
Fields starting with an underscore (_) are not included when emitting
a configuration file (they are when enclosed in double quotes).

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval ./mon/prometheus -e configMap.prometheus
apiVersion: &#34;v1&#34;
kind:       &#34;ConfigMap&#34;
metadata: {
    name: &#34;prometheus&#34;
}
data: {
    &#34;alert.rules&#34;: &#34;&#34;&#34;
        groups:
          - name: rules.yaml
            rules:
...

Yay!

    




    

Quick &rsquo;n Dirty Conversion
In this tutorial we show how to quickly eliminate boilerplate from a set
of configurations.
Manual tailoring will usually give better results, but takes considerably
more thought, while taking the quick and dirty approach gets you mostly there.
The result of such a quick conversion also forms a good basis for
a more thoughtful manual optimization.

    




    

Create top-level template
Now we have imported the YAML files we can start the simplification process.
Before we start the restructuring, lets save a full evaluation so that we
can verify that simplifications yield the same results.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot

The -c option tells cue that only concrete values, that is valid JSON,
are allowed.
We focus on the objects defined in the various kube.cue files.
A quick inspection reveals that many of the Deployments and Services share
common structure.
We copy one of the files containing both as a basis for creating our template
to the root of the directory tree.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cp frontend/breaddispatcher/kube.cue .

Modify this file as below.







            




    


                            Copied!
                        
                    tmp/services/kube.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

service: [ID=_]: {
	apiVersion: &#34;v1&#34;
	kind:       &#34;Service&#34;
	metadata: {
		name: ID
		labels: {
			app:       ID     // by convention
			domain:    &#34;prod&#34; // always the same in the given files
			component: string // varies per directory
		}
	}
	spec: {
		// Any port has the following properties.
		ports: [...{
			port:     int
			protocol: *&#34;TCP&#34; | &#34;UDP&#34; // from the Kubernetes definition
			name:     string | *&#34;client&#34;
		}]
		selector: metadata.labels // we want those to be the same
	}
}

deployment: [ID=_]: {
	apiVersion: &#34;apps/v1&#34;
	kind:       &#34;Deployment&#34;
	metadata: name: ID
	spec: {
		// 1 is the default, but we allow any number
		replicas: *1 | int
		template: {
			metadata: labels: {
				app:       ID
				domain:    &#34;prod&#34;
				component: string
			}
			// we always have one namesake container
			spec: containers: [{name: ID}]
		}
	}
}






By replacing the service and deployment name with [ID=_] we have changed the
definition into a template matching any field.
CUE binds the field name to ID as a result.
During importing we used metadata.name as a key for the object names,
so we can now set this field to ID.
Templates are applied to (are unified with) all entries in the struct in which
they are defined,
so we need to either strip fields specific to the breaddispatcher definition,
generalize them, or remove them.
One of the labels defined in the Kubernetes metadata seems to be always set
to parent directory name.
We enforce this by defining component: string, meaning that a field
of name component must be set to some string value, and then define this
later on.
Any underspecified field results in an error when converting to, for instance,
JSON.
So a deployment or service will only be valid if this label is defined.

Let&rsquo;s compare the result of merging our new template to our original snapshot.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
// k8s.example/services/mon/alertmanager@v0:kube
deployment.alertmanager.spec.template.metadata.labels.component: incomplete value string:
    ./kube.cue:36:16
service.alertmanager.metadata.labels.component: incomplete value string:
    ./kube.cue:11:15
service.alertmanager.spec.selector.component: incomplete value string:
    ./kube.cue:11:15
// k8s.example/services/mon/nodeexporter@v0:kube
service.&#34;node-exporter&#34;.metadata.labels.component: incomplete value string:
    ./kube.cue:11:15
...

Oops.
The alert manager does not specify the component label.
This demonstrates how constraints can be used to catch inconsistencies
in your configurations.
As there are very few objects that do not specify this label, we will modify
the configurations to include them everywhere.
We do this by setting a newly defined top-level field in each directory
to the directory name and modify our master template file to use it.


            TERMINAL
        
                Copy code
                
                    Copied!
                
            # set the component label to our new top-level field
$ sed -i.bak &#39;s/component:.*string/component: #Component/&#39; kube.cue
$ rm kube.cue.bak

# add the new top-level field to our previous template definitions
$ cat &lt;&lt;EOF &gt;&gt;kube.cue

#Component: string
EOF

# add a file with the component label to each directory
$ ls -d */ | sed &#39;s/.$//&#39; | xargs -I DIR sh -c &#39;cd DIR; echo &#34;package kube

#Component: \&#34;DIR\&#34;
&#34; &gt; kube.cue; cd ..&#39;

# format the files
$ cue fmt kube.cue */kube.cue

Let&rsquo;s try again to see if it is fixed:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
--- snapshot
&#43;&#43;&#43; snapshot2
@@ -1,3 &#43;1,9 @@
&#43;service: {}
&#43;deployment: {}
&#43;// ---
&#43;service: {}
&#43;deployment: {}
&#43;// ---
 service: {
     bartender: {
         apiVersion: &#34;v1&#34;
@@ -208,6 &#43;214,7 @@
             selector: {
                 app:    &#34;maitred&#34;
                 domain: &#34;prod&#34;
&#43;                component: &#34;frontend&#34;
             }
         }
     }
...

Except for having more consistent labels and some reordering, nothing changed.
We are happy and save the result as the new baseline.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cp snapshot2 snapshot

The corresponding boilerplate can now be removed with cue trim.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ find . | grep kube.cue | xargs wc -l | tail -1
 1833 total
$ cue trim ./...
$ find . | grep kube.cue | xargs wc -l | tail -1
 1275 total

cue trim removes configuration from files that is already generated
by templates or comprehensions.
In doing so it removed over 500 lines of configuration, or over 30%!
The following is proof that nothing changed semantically:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
$ diff -wu snapshot snapshot2 | wc -l
587

We can do better, though.
A first thing to note is that DaemonSets and StatefulSets share a similar
structure to Deployments.
We generalize the top-level template as follows:







            




    


                            Copied!
                        
                    tmp/services/kube2.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

daemonSet: [ID=_]: _spec &amp; {
	apiVersion: &#34;apps/v1&#34;
	kind:       &#34;DaemonSet&#34;
	_name:      ID
}

statefulSet: [ID=_]: _spec &amp; {
	apiVersion: &#34;apps/v1&#34;
	kind:       &#34;StatefulSet&#34;
	_name:      ID
}

deployment: [ID=_]: _spec &amp; {
	apiVersion: &#34;apps/v1&#34;
	kind:       &#34;Deployment&#34;
	_name:      ID
	spec: replicas: *1 | int
}

configMap: [ID=_]: {
	metadata: name: ID
	metadata: labels: component: #Component
}

_spec: {
	_name: string

	metadata: name: _name
	metadata: labels: component: #Component
	spec: selector: {}
	spec: template: {
		metadata: labels: {
			app:       _name
			component: #Component
			domain:    &#34;prod&#34;
		}
		spec: containers: [{name: _name}]
	}
}






The common configuration has been factored out into _spec.
We introduced _name to aid both specifying and referring
to the name of an object.
For completeness, we added configMap as a top-level entry.
Note that we have not yet removed the old definition of deployment.
This is fine.
As it is equivalent to the new one, unifying them will have no effect.
We leave its removal as an exercise to the reader.
Next we observe that all deployments, stateful sets and daemon sets have
an accompanying service which shares many of the same fields.
We add:







            




    


                            Copied!
                        
                    tmp/services/kube3.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

// Define the _export option and set the default to true
// for all ports defined in all containers.
_spec: spec: template: spec: containers: [...{
	ports: [...{
		_export: *true | false // include the port in the service
	}]
}]

for x in [deployment, daemonSet, statefulSet] for k, v in x {
	service: &#34;\(k)&#34;: {
		spec: selector: v.spec.template.metadata.labels

		spec: ports: [
			for c in v.spec.template.spec.containers
			for p in c.ports
			if p._export {
				let Port = p.containerPort // Port is an alias
				port:       *Port | int
				targetPort: *Port | int
			},
		]
	}
}






This example introduces a few new concepts.
Open-ended lists are indicated with an ellipsis (...).
The value following an ellipsis is unified with any subsequent elements and
defines the &ldquo;type&rdquo;, or template, for additional list elements.
The Port declaration is an alias.
Aliases are only visible in their lexical scope and are not part of the model.
They can be used to make shadowed fields visible within nested scopes or,
in this case, to reduce boilerplate without introducing new fields.
Finally, this example introduces list and field comprehensions.
List comprehensions are analogous to list comprehensions found in other
languages.
Field comprehensions allow inserting fields in structs.
In this case, the field comprehension adds a namesake service for any
deployment, daemonSet, and statefulSet.
Field comprehensions can also be used to add a field conditionally.
Specifying the targetPort is not necessary, but since many files define it,
defining it here will allow those definitions to be removed
using cue trim.
We add an option _export for ports defined in containers to specify whether
to include them in the service and explicitly set this to false
for the respective ports in infra/events, infra/tasks, and infra/watcher.
For the purpose of this tutorial, here are some quick patches:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cat &lt;&lt;EOF &gt;&gt;infra/events/kube.cue

deployment: events: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
EOF
$ cat &lt;&lt;EOF &gt;&gt;infra/tasks/kube.cue

deployment: tasks: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
EOF
$ cat &lt;&lt;EOF &gt;&gt;infra/watcher/kube.cue

deployment: watcher: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
EOF

In practice it would be more proper form to add this field in the original
port declaration.
We verify that all changes are acceptable and store another snapshot.
Then we run trim to further reduce our configuration:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue trim ./...
$ find . | grep kube.cue | xargs wc -l | tail -1
 1212 total

This is after removing the rewritten and now redundant deployment definition.
We shaved off almost another 100 lines, even after adding the template.
You can verify that the service definitions are now gone in most of the files.
What remains is either some additional configuration, or inconsistencies that
should probably be cleaned up.
But we have another trick up our sleeve.
With the -s or --simplify option we can tell trim or fmt to collapse
structs with a single element onto a single line. For instance:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ head frontend/breaddispatcher/kube.cue
package kube

service: breaddispatcher: {
	spec: {
		ports: [{}]
	}
}
deployment: breaddispatcher: {
	spec: {
		template: {


            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue trim ./... -s
$ head frontend/breaddispatcher/kube.cue
package kube

service: breaddispatcher: spec: ports: [{}]
deployment: breaddispatcher: spec: template: {
	metadata: annotations: {
		&#34;prometheus.io.scrape&#34;: &#34;true&#34;
		&#34;prometheus.io.port&#34;:   &#34;7080&#34;
	}
	spec: containers: [{
		image: &#34;gcr.io/myproj/breaddispatcher:v0.3.24&#34;


            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ find . | grep kube.cue | xargs wc -l | tail -1
 1020 total

Another 150 lines lost!
Collapsing lines like this can improve the readability of a configuration
by removing considerable amounts of punctuation.
We save the result as the new baseline:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
$ cp snapshot2 snapshot


    




    

Repeat for several subdirectories
In the previous section we defined templates for services and deployments
in the root of our directory structure to capture the common traits of all
services and deployments.
In addition, we defined a directory-specific label.
In this section we will look into generalizing the objects per directory.

    




    

Directory frontend
We observe that all deployments in subdirectories of frontend
have a single container with one port,
which is usually 7080, but sometimes 8080.
Also, most have two prometheus-related annotations, while some have one.
We leave the inconsistencies in ports, but add both annotations
unconditionally.







            




    


                            Copied!
                        
                    tmp/services/frontend/kube2.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

deployment: [string]: spec: template: {
	metadata: annotations: {
		&#34;prometheus.io.scrape&#34;: &#34;true&#34;
		&#34;prometheus.io.port&#34;:   &#34;\(spec.containers[0].ports[0].containerPort)&#34;
	}
	spec: containers: [{
		ports: [{containerPort: *7080 | int}] // 7080 is the default
	}]
}







            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
--- snapshot
&#43;&#43;&#43; snapshot2
@@ -170,6 &#43;170,7 @@
                 metadata: {
                     annotations: {
                         &#34;prometheus.io.scrape&#34;: &#34;true&#34;
&#43;                        &#34;prometheus.io.port&#34;:   &#34;7080&#34;
                     }
                     labels: {
                         app:       &#34;host&#34;
...
$ cp snapshot2 snapshot

Two lines with annotations added, improving consistency.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue trim ./frontend/... -s
$ find . | grep kube.cue | xargs wc -l | tail -1
 1005 total

Another 40 odd lines removed.
We may have gotten used to larger reductions, but at this point there is just
not much left to remove: in some of the frontend files there are only 4 lines
of configuration left.
We save the result as the new baseline:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue eval -c ./... &gt;snapshot2
$ cp snapshot2 snapshot


    




    

Directory kitchen
In this directory we observe that all deployments have without exception
one container with port 8080, all have the same liveness probe,
a single line of prometheus annotation, and most have
two or three disks with similar patterns.
Let&rsquo;s add everything but the disks for now:







            




    


                            Copied!
                        
                    tmp/services/kitchen/kube2.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

deployment: [string]: spec: template: {
	metadata: annotations: &#34;prometheus.io.scrape&#34;: &#34;true&#34;
	spec: containers: [{
		ports: [{
			containerPort: 8080
		}]
		livenessProbe: {
			httpGet: {
				path: &#34;/debug/health&#34;
				port: 8080
			}
			initialDelaySeconds: 40
			periodSeconds:       3
		}
	}]
}






A diff reveals that one prometheus annotation was added to a service.
We assume this to be an accidental omission and accept the differences
Disks need to be defined in both the template spec section as well as in
the container where they are used.
We prefer to keep these two definitions together.
We take the volumes definition from expiditer (the first config in that
directory with two disks), and generalize it:







            




    


                            Copied!
                        
                    tmp/services/kitchen/kube3.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

deployment: [ID=_]: spec: template: spec: {
	_hasDisks: *true | bool

	// field comprehension using just &#34;if&#34;
	if _hasDisks {
		volumes: [{
			name: *&#34;\(ID)-disk&#34; | string
			gcePersistentDisk: pdName: *&#34;\(ID)-disk&#34; | string
			gcePersistentDisk: fsType: &#34;ext4&#34;
		}, {
			name: *&#34;secret-\(ID)&#34; | string
			secret: secretName: *&#34;\(ID)-secrets&#34; | string
		}, ...]

		containers: [{
			volumeMounts: [{
				name:      *&#34;\(ID)-disk&#34; | string
				mountPath: *&#34;/logs&#34; | string
			}, {
				mountPath: *&#34;/etc/certs&#34; | string
				name:      *&#34;secret-\(ID)&#34; | string
				readOnly:  true
			}, ...]
		}]
	}
}













            




    


                            Copied!
                        
                    tmp/services/kitchen/souschef/kube2.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

deployment: souschef: spec: template: spec: {
	_hasDisks: false
}






This template definition is not ideal: the definitions are positional, so if
configurations were to define the disks in a different order, there would be
no reuse or even conflicts.
Also note that in order to deal with this restriction, almost all field values
are just default values and can be overridden by instances.
A better way would be define a map of volumes,
similarly to how we organized the top-level Kubernetes objects,
and then generate these two sections from this map.
This requires some design, though, and does not belong in a
&ldquo;quick-and-dirty&rdquo; tutorial.
Later in this document we introduce a manually optimized configuration.
We add the two disk by default and define a _hasDisks option to opt out.
The souschef configuration is the only one that defines no disks.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue trim -s ./kitchen/...

# check differences
$ cue eval -c ./... &gt;snapshot2
$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
...
$ cp snapshot2 snapshot
$ find . | grep kube.cue | xargs wc -l | tail -1
  997 total

The diff shows that we added the _hasDisks option, but otherwise reveals no
differences.
We also reduced the configuration by a sizeable amount once more.
However, on closer inspection of the remaining files we see a lot of remaining
fields in the disk specifications as a result of inconsistent naming.
Reducing configurations like we did in this exercise exposes inconsistencies.
The inconsistencies can be removed by simply deleting the overrides in the
specific configuration.
Leaving them as is gives a clear signal that a configuration is inconsistent.

    




    

Conclusion of Quick &rsquo;n Dirty tutorial
There is still some gain to be made with the other directories.
At nearly a 1000-line, or 55%, reduction, we leave the rest as an exercise to
the reader.
We have shown how CUE can be used to reduce boilerplate, enforce consistencies,
and detect inconsistencies.
Being able to deal with consistencies and inconsistencies is a consequence of
the constraint-based model and harder to do with inheritance-based languages.
We have indirectly also shown how CUE is well-suited for machine manipulation.
This is a factor of syntax and the order independence that follows from its
semantics.
The trim command is one of many possible automated refactor tools made
possible by this property.
Also this would be harder to do with inheritance-based configuration languages.

    




    

Define commands
The cue export command can be used to convert the created configuration back
to JSON.
In our case, this requires a top-level &ldquo;emit value&rdquo;
to convert our mapped Kubernetes objects back to a list.
Typically, this output is piped to tools like kubectl or etcdctl.
In practice this means typing the same commands ad nauseam.
The next step is often to write wrapper tools.
But as there is often no one-size-fits-all solution, this lead to the
proliferation of marginally useful tools.
The cue tool provides an alternative by allowing the declaration of
frequently used commands in CUE itself.
Advantages:

added domain knowledge that CUE may use for improved analysis,
only one language to learn,
easy discovery of commands,
no further configuration required,
enforce uniform CLI standards across commands,
standardized commands across an organization.

Commands are defined in files ending with _tool.cue in the same package as
where the configuration files are defined on which the commands should operate.
Top-level values in the configuration are visible by the tool files
as long as they are not shadowed by top-level fields in the tool files.
Top-level fields in the tool files are not visible in the configuration files
and are not part of any model.
The tool definitions also have access to additional builtin packages.
A CUE configuration is fully hermetic, disallowing any outside influence.
This property enables automated analysis and manipulation
such as the trim command.
The tool definitions, however, have access to such things as command line flags
and environment variables, random generators, file listings, and so on.
We define the following tools for our example:

ls: list the Kubernetes objects defined in our configuration
dump: dump all selected objects as a YAML stream
create: send all selected objects to kubectl for creation


    




    

Preparations
To work with Kubernetes we need to convert our map of Kubernetes objects
back to a simple list.
We create the tool file to do just that.







            




    


                            Copied!
                        
                    tmp/services/kube_tool.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

objects: [for v in objectSets for x in v {x}]

objectSets: [
	service,
	deployment,
	statefulSet,
	daemonSet,
	configMap,
]







    




    

Listing objects
Commands are defined in the command section at the top-level of a tool file.
A cue command defines command line flags, environment variables, as well as
a set of tasks.
Examples tasks are load or write a file, dump something to the console,
download a web page, or execute a command.
We start by defining the ls command which dumps all our objects







            




    


                            Copied!
                        
                    tmp/services/ls_tool.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

import (
	&#34;text/tabwriter&#34;
	&#34;tool/cli&#34;
	&#34;tool/file&#34;
)

command: ls: {
	task: print: cli.Print &amp; {
		text: tabwriter.Write([
			for x in objects {
				&#34;\(x.kind)  \t\(x.metadata.labels.component)  \t\(x.metadata.name)&#34;
			},
		])
	}

	task: write: file.Create &amp; {
		filename: &#34;foo.txt&#34;
		contents: task.print.text
	}
}







NOTE: THE API OF THE TASK DEFINITIONS WILL CHANGE.
Although we may keep supporting this form if needed.
The command is now available in the cue tool:

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue cmd ls ./frontend/maitred
Service      frontend   maitred
Deployment   frontend   maitred

If more than one instance is selected the cue tool may either operate
on them one by one or merge them.
The default is to merge them.
Different instances of a package are typically not compatible:
different subdirectories may have different specializations.
A merge pre-expands templates of each instance and then merges their root
values.
The result may contain conflicts, such as our top-level #Component field,
but our per-type maps of Kubernetes objects should be free of conflict
(if there is, we have a problem with Kubernetes down the line).
A merge thus gives us a unified view of all objects.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue cmd ls ./...
Service       frontend   bartender
Service       frontend   breaddispatcher
Service       frontend   host
Service       frontend   maitred
Service       frontend   valeter
Service       frontend   waiter
Service       frontend   waterdispatcher
Service       infra      download
Service       infra      etcd
Service       infra      events
...


    




    

Dumping a YAML Stream
The following adds a command to dump the selected objects as a YAML stream.








            




    


                            Copied!
                        
                    tmp/services/dump_tool.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

import (
	&#34;encoding/yaml&#34;
	&#34;tool/cli&#34;
)

command: dump: {
	task: print: cli.Print &amp; {
		text: yaml.MarshalStream(objects)
	}
}







The MarshalStream command converts the list of objects to a &lsquo;---&rsquo;-separated
stream of YAML values.

    




    

Creating Objects
The create command sends a list of objects to kubectl create.







            




    


                            Copied!
                        
                    tmp/services/create_tool.cue
            
        


                Copy code
                
                    Copied!
                
            package kube

import (
	&#34;encoding/yaml&#34;
	&#34;tool/exec&#34;
	&#34;tool/cli&#34;
)

command: create: {
	task: kube: exec.Run &amp; {
		cmd:    &#34;kubectl create --dry-run=client -f -&#34;
		stdin:  yaml.MarshalStream(objects)
		stdout: string
	}

	task: display: cli.Print &amp; {
		text: task.kube.stdout
	}
}






This command has two tasks, named kube and display.
The display task depends on the output of the kube task.
The cue tool does a static analysis of the dependencies and runs all
tasks which dependencies are satisfied in parallel while blocking tasks
for which an input is missing.

            TERMINAL
        
                Copy code
                
                    Copied!
                
            $ cue cmd create ./frontend/...
apiVersion: v1
kind: Service
metadata:
  name: bartender
  labels:
    app: bartender
    domain: prod
    component: frontend
spec:
  ports:
...

A production real-life version of this could should omit the --dry-run=client flag
of course.

    




    

Extract CUE templates directly from Kubernetes Go source
In order for cue get go to generate the CUE templates from Go sources, you first need to have the sources locally:

                Copy code
                
                    Copied!
                
            $ go get k8s.io/api/apps/v1@v0.23.4
$ cue get go k8s.io/api/apps/v1

Now that we have the Kubernetes definitions in our module, we can import and use them:

                Copy code
                
                    Copied!
                
            $ cat &lt;&lt;EOF &gt; k8s_defs.cue
package kube

import (
	&#34;k8s.io/api/core/v1&#34;
	apps_v1 &#34;k8s.io/api/apps/v1&#34;
)

service: [string]:     v1.#Service
deployment: [string]:  apps_v1.#Deployment
daemonSet: [string]:   apps_v1.#DaemonSet
statefulSet: [string]: apps_v1.#StatefulSet
EOF

And, finally, we&rsquo;ll format again:

                Copy code
                
                    Copied!
                
            cue fmt


    




    

Manually tailored configuration
In Section &ldquo;Quick &rsquo;n Dirty&rdquo; we showed how to quickly get going with CUE.
With a bit more deliberation, one can reduce configurations even further.
Also, we would like to define a configuration that is more generic and less tied
to Kubernetes.
We will rely heavily on CUEs order independence, which makes it easy to
combine two configurations of the same object in a well-defined way.
This makes it easy, for instance, to put frequently used fields in one file
and more esoteric one in another and then combine them without fear that one
will override the other.
We will take this approach in this section.
The end result of this tutorial is in the manual directory.
In the next sections we will show how to get there.

    




    

Outline
The basic premise of our configuration is to maintain two configurations,
a simple and abstract one, and one compatible with Kubernetes.
The Kubernetes version is automatically generated from the simple configuration.
Each simplified object has a kubernetes section that get gets merged into
the Kubernetes object upon conversion.
We define one top-level file with our generic definitions.

                Copy code
                
                    Copied!
                
            // file cloud.cue
package cloud

service: [Name=_]: {
    name: *Name | string // the name of the service

    ...

    // Kubernetes-specific options that get mixed in when converting
    // to Kubernetes.
    kubernetes: {
    }
}

deployment: [Name=_]: {
    name: *Name | string
   ...
}

A Kubernetes-specific file then contains the definitions to
convert the generic objects to Kubernetes.
Overall, the code modeling our services and the code generating the kubernetes
code is separated, while still allowing to inject Kubernetes-specific
data into our general model.
At the same time, we can add additional information to our model without
it ending up in the Kubernetes definitions causing it to barf.

    




    

Deployment Definition
For our design we assume that all Kubernetes Pod derivatives only define one
container.
This is clearly not the case in general, but often it does and it is good
practice.
Conveniently, it simplifies our model as well.
We base the model loosely on the master templates we derived in
Section &ldquo;Quick &rsquo;n Dirty&rdquo;.
The first step we took is to eliminate statefulSet and daemonSet and
rather just have a deployment allowing different kinds.

                Copy code
                
                    Copied!
                
            deployment: [Name=_]: _base &amp; {
    name:     *Name | string
    ...

The kind only needs to be specified if the deployment is a stateful set or
daemonset.
This also eliminates the need for _spec.
The next step is to pull common fields, such as image to the top level.
Arguments can be specified as a map.

                Copy code
                
                    Copied!
                
                arg: [string]: string
    args: [for k, v in arg { &#34;-\(k)=\(v)&#34; }] | [...string]

If order matters, users could explicitly specify the list as well.
For ports we define two simple maps from name to port number:

                Copy code
                
                    Copied!
                
                // expose port defines named ports that is exposed in the service
    expose: port: [string]: int

    // port defines a named port that is not exposed in the service.
    port: [string]: int

Both maps get defined in the container definition, but only port gets
included in the service definition.
This may not be the best model, and does not support all features,
but it shows how one can chose a different representation.
A similar story holds for environment variables.
In most cases mapping strings to string suffices.
The testdata uses other options though.
We define a simple env map and an envSpec for more elaborate cases:

                Copy code
                
                    Copied!
                
                env: [string]: string

    envSpec: [string]: {}
    envSpec: {
        for k, v in env {
            &#34;\(k)&#34; value: v
        }
    }

The simple map automatically gets mapped into the more elaborate map
which then presents the full picture.
Finally, our assumption that there is one container per deployment allows us
to create a single definition for volumes, combining the information for
volume spec and volume mount.

                Copy code
                
                    Copied!
                
                volume: [Name=_]: {
        name:       *Name | string
        mountPath:  string
        subPath:    null | string
        readOnly:   bool
        kubernetes: {}
    }

All other fields that we way want to define can go into a generic kubernetes
struct that gets merged in with all other generated kubernetes data.
This even allows us to augment generated data, such as adding additional
fields to the container.

    




    

Service Definition
The service definition is straightforward.
As we eliminated stateful and daemon sets, the field comprehension to
automatically derive a service is now a bit simpler:

                Copy code
                
                    Copied!
                
            // define services implied by deployments
service: {
    for k, spec in deployment {
        &#34;\(k)&#34;: {
            // Copy over all ports exposed from containers.
            for Name, Port in spec.expose.port {
                port: &#34;\(Name)&#34;: {
                    port:       *Port | int
                    targetPort: *Port | int
                }
            }

            // Copy over the labels
            label: spec.label
        }
    }
}

The complete top-level model definitions can be found at
doc/tutorial/kubernetes/manual/services/cloud.cue.
The tailorings for this specific project (the labels) are defined
here.

    




    

Converting to Kubernetes
Converting services is fairly straightforward.

                Copy code
                
                    Copied!
                
            kubernetes: services: {
    for k, x in service {
        &#34;\(k)&#34;: x.kubernetes &amp; {
            apiVersion: &#34;v1&#34;
            kind:       &#34;Service&#34;

            metadata: name:   x.name
            metadata: labels: x.label
            spec: selector:   x.label

            spec: ports: [for p in x.port { p }]
        }
    }
}

We add the Kubernetes boilerplate, map the top-level fields and mix in
the raw kubernetes fields for each service.
Mapping deployments is a bit more involved, though analogous.
The complete definitions for Kubernetes conversions can be found at
doc/tutorial/kubernetes/manual/services/k8s.cue.
Converting the top-level definitions to concrete Kubernetes code is the hardest
part of this exercise.
That said, most CUE users will never have to resort to this level of CUE
to write configurations.
For instance, none of the files in the subdirectories contain comprehensions,
not even the template files in these directories (such as kitchen/kube.cue).
Furthermore, none of the configuration files in any of the
leaf directories contain string interpolations.

    




    

Metrics
The fully written out manual configuration can be found in the manual
subdirectory.
Running our usual count yields

                Copy code
                
                    Copied!
                
            $ find . | grep kube.cue | xargs wc | tail -1
     542    1190   11520 total

This does not count our conversion templates.
Assuming that the top-level templates are reusable, and if we don&rsquo;t count them
for both approaches, the manual approach shaves off about another 150 lines.
If we count the templates as well, the two approaches are roughly equal.

    




    

Conclusions Manual Configuration
We have shown that we can further compact a configuration by manually
optimizing template files.
However, we have also shown that the manual optimization only gives
a marginal benefit with respect to the quick-and-dirty semi-automatic reduction.
The benefits for the manual definition largely lies in the organizational
flexibility one gets.
Manually tailoring your configurations allows creating an abstraction layer
between logical definitions and Kubernetes-specific definitions.
At the same time, CUE&rsquo;s order independence
makes it easy to mix in low-level Kubernetes configuration wherever it is
convenient and applicable.
Manual tailoring also allows us to add our own definitions without breaking
Kubernetes.
This is crucial in defining information relevant to definitions,
but unrelated to Kubernetes, where they belong.
Separating abstract from concrete configuration also allows us to create
difference adaptors for the same configuration.

">
<meta itemprop="wordCount" content="5684">


                <div class="article__container">
                    



<header class="article__header">
        </header>



                    <div class="article__content">
                        
                            <div class="note note--caution" role="alert">



<svg class="icon note__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--exclamation"></use>
</svg>
<div class="note__content">Source: <a href="https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial">https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial</a></div>
</div>

<p>In this tutorial we show how to convert Kubernetes configuration files
for a collection of microservices.</p>
<p>The configuration files are scrubbed and renamed versions of
real-life configuration files.
The files are organized in a directory hierarchy grouping related services
in subdirectories.
This is a common pattern.
The <code>cue</code> tooling has been optimized for this use case.</p>
<p>In this tutorial we will address the following topics:</p>
<ol>
<li>convert the given YAML files to CUE</li>
<li>hoist common patterns to parent directories</li>
<li>use the tooling to rewrite CUE files to drop unnecessary fields</li>
<li>repeat from step 2 for different subdirectories</li>
<li>define commands to operate on the configuration</li>
<li>extract CUE templates directly from Kubernetes Go source</li>
<li>manually tailor the configuration</li>
<li>map a Kubernetes configuration to <code>docker-compose</code> (TODO)</li>
</ol>
<h2 id="the-given-data-set">
    <a href="#the-given-data-set" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>The given data set</h2>
<p>The data set is based on a real-life case, using different names for the
services.
All the inconsistencies of the real setup are replicated in the files
to get a realistic impression of how a conversion to CUE would behave
in practice.</p>
<p>The given YAML files are ordered in following directory
(you can use <code>find</code> if you don&rsquo;t have tree):</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ZmluZCAuL29yaWdpbmFsIC10eXBlIGYgfCBzb3J0">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ find ./original -type f | sort
</span></span><span style="display:flex;"><span>./original/services/frontend/bartender/kube.yaml
</span></span><span style="display:flex;"><span>./original/services/frontend/breaddispatcher/kube.yaml
</span></span><span style="display:flex;"><span>./original/services/frontend/host/kube.yaml
</span></span><span style="display:flex;"><span>./original/services/frontend/maitred/kube.yaml
</span></span><span style="display:flex;"><span>./original/services/frontend/valeter/kube.yaml
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>Each subdirectory contains related microservices that often share similar
characteristics and configurations.
The configurations include a large variety of Kubernetes objects, including
services, deployments, config maps,
a daemon set, a stateful set, and a cron job.</p>
<p>The result of the first tutorial is in the <code>quick</code>, for &ldquo;quick and dirty&rdquo;
directory.
A manually optimized configuration can be found int <code>manual</code>
directory.</p>
<h2 id="importing-existing-configuration">
    <a href="#importing-existing-configuration" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Importing existing configuration</h2>
<p>We first make a copy of the data directory.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3AgLWEgb3JpZ2luYWwgdG1wCmNkIHRtcA==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cp -a original tmp
</span></span><span style="display:flex;"><span>$ cd tmp</span></span></code></pre></div></div>
</div>
<p>We initialize a module so that we can treat all our configuration files
in the subdirectories as part of one package.
We do that later by giving all the same package name.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIG1vZCBpbml0IGs4cy5leGFtcGxl">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue mod init k8s.example</span></span></code></pre></div></div>
</div>
<p>Creating a module also allows our packages import external packages.</p>
<p>We initialize a Go module so that later we can resolve the
<code>k8s.io/api/apps/v1</code> Go package dependency:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Z28gbW9kIGluaXQgazhzLmV4YW1wbGU=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ go mod init k8s.example
</span></span><span style="display:flex;"><span>go: creating new go.mod: module k8s.example
</span></span><span style="display:flex;"><span>go: to add module requirements and sums:
</span></span><span style="display:flex;"><span>	go mod tidy</span></span></code></pre></div></div>
</div>
<p>Let&rsquo;s try to use the <code>cue import</code> command to convert the given YAML files
into CUE.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y2Qgc2VydmljZXM=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cd services</span></span></code></pre></div></div>
</div>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="JCBjZCBzZXJ2aWNlcw==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>$ cd services</code></pre></div>
</div>
<p>Since we have multiple packages and files, we need to specify the package to
which they should belong.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGltcG9ydCAuLy4uLiAtcCBrdWJl">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue import ./... -p kube
</span></span><span style="display:flex;"><span>path, list, or files flag needed to handle multiple objects in file ./services/frontend/bartender/kube.yaml</span></span></code></pre></div></div>
</div>
<p>Many of the files contain more than one Kubernetes object.
Moreover, we are creating a single configuration that contains all objects
from all files.
We need to organize all Kubernetes objects such that each is individually
identifiable within the single configuration.
We do so by defining a different struct for each type putting each object
in this respective struct keyed by its name.
This allows objects of different types to share the same name,
just as is allowed by Kubernetes.
To accomplish this, we tell <code>cue</code> to put each object in the configuration
tree at the path with the &ldquo;kind&rdquo; as first element and &ldquo;name&rdquo; as second.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGltcG9ydCAuLy4uLiAtcCBrdWJlIC1sICdzdHJpbmdzLlRvQ2FtZWwoa2luZCknIC1sIG1ldGFkYXRhLm5hbWUgLWY=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue import ./... -p kube -l &#39;strings.ToCamel(kind)&#39; -l metadata.name -f</span></span></code></pre></div></div>
</div>
<p>The added <code>-l</code> flag defines the labels for each object, based on values from
each object, using the usual CUE syntax for field labels.
In this case, we use a camelcase variant of the <code>kind</code> field of each object and
use the <code>name</code> field of the <code>metadata</code> section as the name for each object.
We also added the <code>-f</code> flag to overwrite the few files that succeeded before.</p>
<p>Let&rsquo;s see what happened:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ZmluZCAuIC10eXBlIGYgfCBzb3J0">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ find . -type f | sort
</span></span><span style="display:flex;"><span>./frontend/bartender/kube.cue
</span></span><span style="display:flex;"><span>./frontend/bartender/kube.yaml
</span></span><span style="display:flex;"><span>./frontend/breaddispatcher/kube.cue
</span></span><span style="display:flex;"><span>./frontend/breaddispatcher/kube.yaml
</span></span><span style="display:flex;"><span>./frontend/host/kube.cue
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>Each of the YAML files is converted to corresponding CUE files.
Comments of the YAML files are preserved.</p>
<p>The result is not fully pleasing, though.
Take a look at <code>mon/prometheus/configmap.cue</code>.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="aGVhZCBtb24vcHJvbWV0aGV1cy9jb25maWdtYXAuY3Vl">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ head mon/prometheus/configmap.cue
</span></span><span style="display:flex;"><span>package kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>configMap: prometheus: {
</span></span><span style="display:flex;"><span>	apiVersion: &#34;v1&#34;
</span></span><span style="display:flex;"><span>	kind:       &#34;ConfigMap&#34;
</span></span><span style="display:flex;"><span>	metadata: name: &#34;prometheus&#34;
</span></span><span style="display:flex;"><span>	data: {
</span></span><span style="display:flex;"><span>		&#34;alert.rules&#34;: &#34;&#34;&#34;
</span></span><span style="display:flex;"><span>			groups:
</span></span><span style="display:flex;"><span>			- name: rules.yaml</span></span></code></pre></div></div>
</div>
<p>The configuration file still contains YAML embedded in a string value of one
of the fields.
The original YAML file might have looked like it was all structured data, but
the majority of it was a string containing, hopefully, valid YAML.</p>
<p>The <code>-R</code> option attempts to detect structured YAML or JSON strings embedded
in the configuration files and then converts these recursively.</p>
<!-- TODO: update import label format -->
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGltcG9ydCAuLy4uLiAtcCBrdWJlIC1sICdzdHJpbmdzLlRvQ2FtZWwoa2luZCknIC1sIG1ldGFkYXRhLm5hbWUgLWYgLVI=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue import ./... -p kube -l &#39;strings.ToCamel(kind)&#39; -l metadata.name -f -R</span></span></code></pre></div></div>
</div>
<p>Now the file looks like:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="aGVhZCBtb24vcHJvbWV0aGV1cy9jb25maWdtYXAuY3Vl">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ head mon/prometheus/configmap.cue
</span></span><span style="display:flex;"><span>package kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import &#34;encoding/yaml&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>configMap: prometheus: {
</span></span><span style="display:flex;"><span>	apiVersion: &#34;v1&#34;
</span></span><span style="display:flex;"><span>	kind:       &#34;ConfigMap&#34;
</span></span><span style="display:flex;"><span>	metadata: name: &#34;prometheus&#34;
</span></span><span style="display:flex;"><span>	data: {
</span></span><span style="display:flex;"><span>		&#34;alert.rules&#34;: yaml.Marshal(_cue_alert_rules)</span></span></code></pre></div></div>
</div>
<p>That looks better!
The resulting configuration file replaces the original embedded string
with a call to <code>yaml.Marshal</code> converting a structured CUE source to
a string with an equivalent YAML file.
Fields starting with an underscore (<code>_</code>) are not included when emitting
a configuration file (they are when enclosed in double quotes).</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLi9tb24vcHJvbWV0aGV1cyAtZSBjb25maWdNYXAucHJvbWV0aGV1cw==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval ./mon/prometheus -e configMap.prometheus
</span></span><span style="display:flex;"><span>apiVersion: &#34;v1&#34;
</span></span><span style="display:flex;"><span>kind:       &#34;ConfigMap&#34;
</span></span><span style="display:flex;"><span>metadata: {
</span></span><span style="display:flex;"><span>    name: &#34;prometheus&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>data: {
</span></span><span style="display:flex;"><span>    &#34;alert.rules&#34;: &#34;&#34;&#34;
</span></span><span style="display:flex;"><span>        groups:
</span></span><span style="display:flex;"><span>          - name: rules.yaml
</span></span><span style="display:flex;"><span>            rules:
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>Yay!</p>
<h2 id="quick-n-dirty-conversion">
    <a href="#quick-n-dirty-conversion" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Quick &rsquo;n Dirty Conversion</h2>
<p>In this tutorial we show how to quickly eliminate boilerplate from a set
of configurations.
Manual tailoring will usually give better results, but takes considerably
more thought, while taking the quick and dirty approach gets you mostly there.
The result of such a quick conversion also forms a good basis for
a more thoughtful manual optimization.</p>
<h3 id="create-top-level-template">
    <a href="#create-top-level-template" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Create top-level template</h3>
<p>Now we have imported the YAML files we can start the simplification process.</p>
<p>Before we start the restructuring, lets save a full evaluation so that we
can verify that simplifications yield the same results.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot</span></span></code></pre></div></div>
</div>
<p>The <code>-c</code> option tells <code>cue</code> that only concrete values, that is valid JSON,
are allowed.
We focus on the objects defined in the various <code>kube.cue</code> files.
A quick inspection reveals that many of the Deployments and Services share
common structure.</p>
<p>We copy one of the files containing both as a basis for creating our template
to the root of the directory tree.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3AgZnJvbnRlbmQvYnJlYWRkaXNwYXRjaGVyL2t1YmUuY3VlIC4=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cp frontend/breaddispatcher/kube.cue .</span></span></code></pre></div></div>
</div>
<p>Modify this file as below.</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kube.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kube.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kube.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kube.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpzZXJ2aWNlOiBbSUQ9X106IHsKCWFwaVZlcnNpb246ICJ2MSIKCWtpbmQ6ICAgICAgICJTZXJ2aWNlIgoJbWV0YWRhdGE6IHsKCQluYW1lOiBJRAoJCWxhYmVsczogewoJCQlhcHA6ICAgICAgIElEICAgICAvLyBieSBjb252ZW50aW9uCgkJCWRvbWFpbjogICAgInByb2QiIC8vIGFsd2F5cyB0aGUgc2FtZSBpbiB0aGUgZ2l2ZW4gZmlsZXMKCQkJY29tcG9uZW50OiBzdHJpbmcgLy8gdmFyaWVzIHBlciBkaXJlY3RvcnkKCQl9Cgl9CglzcGVjOiB7CgkJLy8gQW55IHBvcnQgaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcy4KCQlwb3J0czogWy4uLnsKCQkJcG9ydDogICAgIGludAoJCQlwcm90b2NvbDogKiJUQ1AiIHwgIlVEUCIgLy8gZnJvbSB0aGUgS3ViZXJuZXRlcyBkZWZpbml0aW9uCgkJCW5hbWU6ICAgICBzdHJpbmcgfCAqImNsaWVudCIKCQl9XQoJCXNlbGVjdG9yOiBtZXRhZGF0YS5sYWJlbHMgLy8gd2Ugd2FudCB0aG9zZSB0byBiZSB0aGUgc2FtZQoJfQp9CgpkZXBsb3ltZW50OiBbSUQ9X106IHsKCWFwaVZlcnNpb246ICJhcHBzL3YxIgoJa2luZDogICAgICAgIkRlcGxveW1lbnQiCgltZXRhZGF0YTogbmFtZTogSUQKCXNwZWM6IHsKCQkvLyAxIGlzIHRoZSBkZWZhdWx0LCBidXQgd2UgYWxsb3cgYW55IG51bWJlcgoJCXJlcGxpY2FzOiAqMSB8IGludAoJCXRlbXBsYXRlOiB7CgkJCW1ldGFkYXRhOiBsYWJlbHM6IHsKCQkJCWFwcDogICAgICAgSUQKCQkJCWRvbWFpbjogICAgInByb2QiCgkJCQljb21wb25lbnQ6IHN0cmluZwoJCQl9CgkJCS8vIHdlIGFsd2F5cyBoYXZlIG9uZSBuYW1lc2FrZSBjb250YWluZXIKCQkJc3BlYzogY29udGFpbmVyczogW3tuYW1lOiBJRH1dCgkJfQoJfQp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> {
</span></span><span style="display:flex;"><span>	apiVersion<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span>	kind<span style="font-weight:bold">:</span>       <span style="color:#b84">&#34;Service&#34;</span>
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		name<span style="font-weight:bold">:</span> ID
</span></span><span style="display:flex;"><span>		labels<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>			app<span style="font-weight:bold">:</span>       ID     <span style="color:#998;font-style:italic">// by convention</span>
</span></span><span style="display:flex;"><span>			domain<span style="font-weight:bold">:</span>    <span style="color:#b84">&#34;prod&#34;</span> <span style="color:#998;font-style:italic">// always the same in the given files</span>
</span></span><span style="display:flex;"><span>			component<span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span> <span style="color:#998;font-style:italic">// varies per directory</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Any port has the following properties.</span>
</span></span><span style="display:flex;"><span>		ports<span style="font-weight:bold">:</span> <span style="font-weight:bold">[...</span>{
</span></span><span style="display:flex;"><span>			port<span style="font-weight:bold">:</span>     <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>			protocol<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;TCP&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#b84">&#34;UDP&#34;</span> <span style="color:#998;font-style:italic">// from the Kubernetes definition</span>
</span></span><span style="display:flex;"><span>			name<span style="font-weight:bold">:</span>     <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">|</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;client&#34;</span>
</span></span><span style="display:flex;"><span>		}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		selector<span style="font-weight:bold">:</span> metadata.labels <span style="color:#998;font-style:italic">// we want those to be the same</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> {
</span></span><span style="display:flex;"><span>	apiVersion<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;apps/v1&#34;</span>
</span></span><span style="display:flex;"><span>	kind<span style="font-weight:bold">:</span>       <span style="color:#b84">&#34;Deployment&#34;</span>
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> name<span style="font-weight:bold">:</span> ID
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// 1 is the default, but we allow any number</span>
</span></span><span style="display:flex;"><span>		replicas<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#099">1</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>		template<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>			metadata<span style="font-weight:bold">:</span> labels<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>				app<span style="font-weight:bold">:</span>       ID
</span></span><span style="display:flex;"><span>				domain<span style="font-weight:bold">:</span>    <span style="color:#b84">&#34;prod&#34;</span>
</span></span><span style="display:flex;"><span>				component<span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// we always have one namesake container</span>
</span></span><span style="display:flex;"><span>			spec<span style="font-weight:bold">:</span> containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{name<span style="font-weight:bold">:</span> ID}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<p>By replacing the service and deployment name with <code>[ID=_]</code> we have changed the
definition into a template matching any field.
CUE binds the field name to <code>ID</code> as a result.
During importing we used <code>metadata.name</code> as a key for the object names,
so we can now set this field to <code>ID</code>.</p>
<p>Templates are applied to (are unified with) all entries in the struct in which
they are defined,
so we need to either strip fields specific to the <code>breaddispatcher</code> definition,
generalize them, or remove them.</p>
<p>One of the labels defined in the Kubernetes metadata seems to be always set
to parent directory name.
We enforce this by defining <code>component: string</code>, meaning that a field
of name <code>component</code> must be set to some string value, and then define this
later on.
Any underspecified field results in an error when converting to, for instance,
JSON.
So a deployment or service will only be valid if this label is defined.</p>
<!-- TODO: once cycles in disjunctions are implemented
    port:       targetPort | int   // by default the same as targetPort
    targetPort: port | int         // by default the same as port

Note that ports definition for service contains a cycle.
Specifying one of the ports will break the cycle.
The meaning of cycles are well-defined in CUE.
In practice this means that a template writer does not have to make any
assumptions about which of the fields that can be mutually derived from each
other a user of the template will want to specify.
-->
<p>Let&rsquo;s compare the result of merging our new template to our original snapshot.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90Mg==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>// k8s.example/services/mon/alertmanager@v0:kube
</span></span><span style="display:flex;"><span>deployment.alertmanager.spec.template.metadata.labels.component: incomplete value string:
</span></span><span style="display:flex;"><span>    ./kube.cue:36:16
</span></span><span style="display:flex;"><span>service.alertmanager.metadata.labels.component: incomplete value string:
</span></span><span style="display:flex;"><span>    ./kube.cue:11:15
</span></span><span style="display:flex;"><span>service.alertmanager.spec.selector.component: incomplete value string:
</span></span><span style="display:flex;"><span>    ./kube.cue:11:15
</span></span><span style="display:flex;"><span>// k8s.example/services/mon/nodeexporter@v0:kube
</span></span><span style="display:flex;"><span>service.&#34;node-exporter&#34;.metadata.labels.component: incomplete value string:
</span></span><span style="display:flex;"><span>    ./kube.cue:11:15
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>Oops.
The alert manager does not specify the <code>component</code> label.
This demonstrates how constraints can be used to catch inconsistencies
in your configurations.</p>
<p>As there are very few objects that do not specify this label, we will modify
the configurations to include them everywhere.
We do this by setting a newly defined top-level field in each directory
to the directory name and modify our master template file to use it.</p>
<!--
```
$ cue add */kube.cue -p kube --list <<EOF
#Component: "{{.DisplayPath}}"
EOF
```
-->
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="c2VkIC1pLmJhayAncy9jb21wb25lbnQ6LipzdHJpbmcvY29tcG9uZW50OiAjQ29tcG9uZW50Lycga3ViZS5jdWUKcm0ga3ViZS5jdWUuYmFrCmNhdCA8PEVPRiA&#43;Pmt1YmUuY3VlCgojQ29tcG9uZW50OiBzdHJpbmcKRU9GCmxzIC1kICovIHwgc2VkICdzLy4kLy8nIHwgeGFyZ3MgLUkgRElSIHNoIC1jICdjZCBESVI7IGVjaG8gInBhY2thZ2Uga3ViZQoKI0NvbXBvbmVudDogXCJESVJcIgoiID4ga3ViZS5jdWU7IGNkIC4uJwpjdWUgZm10IGt1YmUuY3VlICova3ViZS5jdWU=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># set the component label to our new top-level field
</span></span><span style="display:flex;"><span>$ sed -i.bak &#39;s/component:.*string/component: #Component/&#39; kube.cue
</span></span><span style="display:flex;"><span>$ rm kube.cue.bak
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># add the new top-level field to our previous template definitions
</span></span><span style="display:flex;"><span>$ cat &lt;&lt;EOF &gt;&gt;kube.cue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#Component: string
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># add a file with the component label to each directory
</span></span><span style="display:flex;"><span>$ ls -d */ | sed &#39;s/.$//&#39; | xargs -I DIR sh -c &#39;cd DIR; echo &#34;package kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#Component: \&#34;DIR\&#34;
</span></span><span style="display:flex;"><span>&#34; &gt; kube.cue; cd ..&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># format the files
</span></span><span style="display:flex;"><span>$ cue fmt kube.cue */kube.cue</span></span></code></pre></div></div>
</div>
<p>Let&rsquo;s try again to see if it is fixed:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90MgpkaWZmIC13dSBzbmFwc2hvdCBzbmFwc2hvdDIgLS1sYWJlbCBzbmFwc2hvdCAtLWxhYmVsIHNuYXBzaG90Mg==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
</span></span><span style="display:flex;"><span>--- snapshot
</span></span><span style="display:flex;"><span>+++ snapshot2
</span></span><span style="display:flex;"><span>@@ -1,3 +1,9 @@
</span></span><span style="display:flex;"><span>+service: {}
</span></span><span style="display:flex;"><span>+deployment: {}
</span></span><span style="display:flex;"><span>+// ---
</span></span><span style="display:flex;"><span>+service: {}
</span></span><span style="display:flex;"><span>+deployment: {}
</span></span><span style="display:flex;"><span>+// ---
</span></span><span style="display:flex;"><span> service: {
</span></span><span style="display:flex;"><span>     bartender: {
</span></span><span style="display:flex;"><span>         apiVersion: &#34;v1&#34;
</span></span><span style="display:flex;"><span>@@ -208,6 +214,7 @@
</span></span><span style="display:flex;"><span>             selector: {
</span></span><span style="display:flex;"><span>                 app:    &#34;maitred&#34;
</span></span><span style="display:flex;"><span>                 domain: &#34;prod&#34;
</span></span><span style="display:flex;"><span>+                component: &#34;frontend&#34;
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>Except for having more consistent labels and some reordering, nothing changed.
We are happy and save the result as the new baseline.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3Agc25hcHNob3QyIHNuYXBzaG90">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cp snapshot2 snapshot</span></span></code></pre></div></div>
</div>
<p>The corresponding boilerplate can now be removed with <code>cue trim</code>.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ZmluZCAuIHwgZ3JlcCBrdWJlLmN1ZSB8IHhhcmdzIHdjIC1sIHwgdGFpbCAtMQpjdWUgdHJpbSAuLy4uLgpmaW5kIC4gfCBncmVwIGt1YmUuY3VlIHwgeGFyZ3Mgd2MgLWwgfCB0YWlsIC0x">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span> 1833 total
</span></span><span style="display:flex;"><span>$ cue trim ./...
</span></span><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span> 1275 total</span></span></code></pre></div></div>
</div>
<p><code>cue trim</code> removes configuration from files that is already generated
by templates or comprehensions.
In doing so it removed over 500 lines of configuration, or over 30%!</p>
<p>The following is proof that nothing changed semantically:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90MgpkaWZmIC13dSBzbmFwc2hvdCBzbmFwc2hvdDIgfCB3YyAtbA==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ diff -wu snapshot snapshot2 | wc -l
</span></span><span style="display:flex;"><span>587</span></span></code></pre></div></div>
</div>
<p>We can do better, though.
A first thing to note is that DaemonSets and StatefulSets share a similar
structure to Deployments.
We generalize the top-level template as follows:</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kube2.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kube2.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kube2.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kube2.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpkYWVtb25TZXQ6IFtJRD1fXTogX3NwZWMgJiB7CglhcGlWZXJzaW9uOiAiYXBwcy92MSIKCWtpbmQ6ICAgICAgICJEYWVtb25TZXQiCglfbmFtZTogICAgICBJRAp9CgpzdGF0ZWZ1bFNldDogW0lEPV9dOiBfc3BlYyAmIHsKCWFwaVZlcnNpb246ICJhcHBzL3YxIgoJa2luZDogICAgICAgIlN0YXRlZnVsU2V0IgoJX25hbWU6ICAgICAgSUQKfQoKZGVwbG95bWVudDogW0lEPV9dOiBfc3BlYyAmIHsKCWFwaVZlcnNpb246ICJhcHBzL3YxIgoJa2luZDogICAgICAgIkRlcGxveW1lbnQiCglfbmFtZTogICAgICBJRAoJc3BlYzogcmVwbGljYXM6ICoxIHwgaW50Cn0KCmNvbmZpZ01hcDogW0lEPV9dOiB7CgltZXRhZGF0YTogbmFtZTogSUQKCW1ldGFkYXRhOiBsYWJlbHM6IGNvbXBvbmVudDogI0NvbXBvbmVudAp9Cgpfc3BlYzogewoJX25hbWU6IHN0cmluZwoKCW1ldGFkYXRhOiBuYW1lOiBfbmFtZQoJbWV0YWRhdGE6IGxhYmVsczogY29tcG9uZW50OiAjQ29tcG9uZW50CglzcGVjOiBzZWxlY3Rvcjoge30KCXNwZWM6IHRlbXBsYXRlOiB7CgkJbWV0YWRhdGE6IGxhYmVsczogewoJCQlhcHA6ICAgICAgIF9uYW1lCgkJCWNvbXBvbmVudDogI0NvbXBvbmVudAoJCQlkb21haW46ICAgICJwcm9kIgoJCX0KCQlzcGVjOiBjb250YWluZXJzOiBbe25hbWU6IF9uYW1lfV0KCX0KfQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>daemonSet<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> _spec <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>	apiVersion<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;apps/v1&#34;</span>
</span></span><span style="display:flex;"><span>	kind<span style="font-weight:bold">:</span>       <span style="color:#b84">&#34;DaemonSet&#34;</span>
</span></span><span style="display:flex;"><span>	_name<span style="font-weight:bold">:</span>      ID
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>statefulSet<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> _spec <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>	apiVersion<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;apps/v1&#34;</span>
</span></span><span style="display:flex;"><span>	kind<span style="font-weight:bold">:</span>       <span style="color:#b84">&#34;StatefulSet&#34;</span>
</span></span><span style="display:flex;"><span>	_name<span style="font-weight:bold">:</span>      ID
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> _spec <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>	apiVersion<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;apps/v1&#34;</span>
</span></span><span style="display:flex;"><span>	kind<span style="font-weight:bold">:</span>       <span style="color:#b84">&#34;Deployment&#34;</span>
</span></span><span style="display:flex;"><span>	_name<span style="font-weight:bold">:</span>      ID
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> replicas<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#099">1</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>configMap<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> {
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> name<span style="font-weight:bold">:</span> ID
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> labels<span style="font-weight:bold">:</span> component<span style="font-weight:bold">:</span> #Component
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_spec<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	_name<span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> name<span style="font-weight:bold">:</span> _name
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> labels<span style="font-weight:bold">:</span> component<span style="font-weight:bold">:</span> #Component
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> selector<span style="font-weight:bold">:</span> {}
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		metadata<span style="font-weight:bold">:</span> labels<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>			app<span style="font-weight:bold">:</span>       _name
</span></span><span style="display:flex;"><span>			component<span style="font-weight:bold">:</span> #Component
</span></span><span style="display:flex;"><span>			domain<span style="font-weight:bold">:</span>    <span style="color:#b84">&#34;prod&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		spec<span style="font-weight:bold">:</span> containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{name<span style="font-weight:bold">:</span> _name}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<p>The common configuration has been factored out into <code>_spec</code>.
We introduced <code>_name</code> to aid both specifying and referring
to the name of an object.
For completeness, we added <code>configMap</code> as a top-level entry.</p>
<p>Note that we have not yet removed the old definition of deployment.
This is fine.
As it is equivalent to the new one, unifying them will have no effect.
We leave its removal as an exercise to the reader.</p>
<p>Next we observe that all deployments, stateful sets and daemon sets have
an accompanying service which shares many of the same fields.
We add:</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kube3.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kube3.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kube3.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kube3.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgovLyBEZWZpbmUgdGhlIF9leHBvcnQgb3B0aW9uIGFuZCBzZXQgdGhlIGRlZmF1bHQgdG8gdHJ1ZQovLyBmb3IgYWxsIHBvcnRzIGRlZmluZWQgaW4gYWxsIGNvbnRhaW5lcnMuCl9zcGVjOiBzcGVjOiB0ZW1wbGF0ZTogc3BlYzogY29udGFpbmVyczogWy4uLnsKCXBvcnRzOiBbLi4uewoJCV9leHBvcnQ6ICp0cnVlIHwgZmFsc2UgLy8gaW5jbHVkZSB0aGUgcG9ydCBpbiB0aGUgc2VydmljZQoJfV0KfV0KCmZvciB4IGluIFtkZXBsb3ltZW50LCBkYWVtb25TZXQsIHN0YXRlZnVsU2V0XSBmb3IgaywgdiBpbiB4IHsKCXNlcnZpY2U6ICJcKGspIjogewoJCXNwZWM6IHNlbGVjdG9yOiB2LnNwZWMudGVtcGxhdGUubWV0YWRhdGEubGFiZWxzCgoJCXNwZWM6IHBvcnRzOiBbCgkJCWZvciBjIGluIHYuc3BlYy50ZW1wbGF0ZS5zcGVjLmNvbnRhaW5lcnMKCQkJZm9yIHAgaW4gYy5wb3J0cwoJCQlpZiBwLl9leHBvcnQgewoJCQkJbGV0IFBvcnQgPSBwLmNvbnRhaW5lclBvcnQgLy8gUG9ydCBpcyBhbiBhbGlhcwoJCQkJcG9ydDogICAgICAgKlBvcnQgfCBpbnQKCQkJCXRhcmdldFBvcnQ6ICpQb3J0IHwgaW50CgkJCX0sCgkJXQoJfQp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Define the _export option and set the default to true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// for all ports defined in all containers.</span>
</span></span><span style="display:flex;"><span>_spec<span style="font-weight:bold">:</span> spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> spec<span style="font-weight:bold">:</span> containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[...</span>{
</span></span><span style="display:flex;"><span>	ports<span style="font-weight:bold">:</span> <span style="font-weight:bold">[...</span>{
</span></span><span style="display:flex;"><span>		_export<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="font-weight:bold">true</span> <span style="font-weight:bold">|</span> <span style="font-weight:bold">false</span> <span style="color:#998;font-style:italic">// include the port in the service</span>
</span></span><span style="display:flex;"><span>	}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> <span style="font-weight:bold">[</span>deployment<span style="font-weight:bold">,</span> daemonSet<span style="font-weight:bold">,</span> statefulSet<span style="font-weight:bold">]</span> <span style="font-weight:bold">for</span> k<span style="font-weight:bold">,</span> v <span style="font-weight:bold">in</span> x {
</span></span><span style="display:flex;"><span>	service<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>k<span style="color:#b84">)</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		spec<span style="font-weight:bold">:</span> selector<span style="font-weight:bold">:</span> v.spec.template.metadata.labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		spec<span style="font-weight:bold">:</span> ports<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">for</span> c <span style="font-weight:bold">in</span> v.spec.template.spec.containers
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">for</span> p <span style="font-weight:bold">in</span> c.ports
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">if</span> p._export {
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">let</span> Port <span style="font-weight:bold">=</span> p.containerPort <span style="color:#998;font-style:italic">// Port is an alias</span>
</span></span><span style="display:flex;"><span>				port<span style="font-weight:bold">:</span>       <span style="font-weight:bold">*</span>Port <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>				targetPort<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span>Port <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>			}<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<p>This example introduces a few new concepts.
Open-ended lists are indicated with an ellipsis (<code>...</code>).
The value following an ellipsis is unified with any subsequent elements and
defines the &ldquo;type&rdquo;, or template, for additional list elements.</p>
<p>The <code>Port</code> declaration is an alias.
Aliases are only visible in their lexical scope and are not part of the model.
They can be used to make shadowed fields visible within nested scopes or,
in this case, to reduce boilerplate without introducing new fields.</p>
<p>Finally, this example introduces list and field comprehensions.
List comprehensions are analogous to list comprehensions found in other
languages.
Field comprehensions allow inserting fields in structs.
In this case, the field comprehension adds a namesake service for any
deployment, daemonSet, and statefulSet.
Field comprehensions can also be used to add a field conditionally.</p>
<p>Specifying the <code>targetPort</code> is not necessary, but since many files define it,
defining it here will allow those definitions to be removed
using <code>cue trim</code>.
We add an option <code>_export</code> for ports defined in containers to specify whether
to include them in the service and explicitly set this to false
for the respective ports in <code>infra/events</code>, <code>infra/tasks</code>, and <code>infra/watcher</code>.</p>
<p>For the purpose of this tutorial, here are some quick patches:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y2F0IDw8RU9GID4&#43;aW5mcmEvZXZlbnRzL2t1YmUuY3VlCgpkZXBsb3ltZW50OiBldmVudHM6IHNwZWM6IHRlbXBsYXRlOiBzcGVjOiBjb250YWluZXJzOiBbeyBwb3J0czogW3tfZXhwb3J0OiBmYWxzZX0sIF9dIH1dCkVPRgpjYXQgPDxFT0YgPj5pbmZyYS90YXNrcy9rdWJlLmN1ZQoKZGVwbG95bWVudDogdGFza3M6IHNwZWM6IHRlbXBsYXRlOiBzcGVjOiBjb250YWluZXJzOiBbeyBwb3J0czogW3tfZXhwb3J0OiBmYWxzZX0sIF9dIH1dCkVPRgpjYXQgPDxFT0YgPj5pbmZyYS93YXRjaGVyL2t1YmUuY3VlCgpkZXBsb3ltZW50OiB3YXRjaGVyOiBzcGVjOiB0ZW1wbGF0ZTogc3BlYzogY29udGFpbmVyczogW3sgcG9ydHM6IFt7X2V4cG9ydDogZmFsc2V9LCBfXSB9XQpFT0Y=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cat &lt;&lt;EOF &gt;&gt;infra/events/kube.cue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment: events: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>$ cat &lt;&lt;EOF &gt;&gt;infra/tasks/kube.cue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment: tasks: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>$ cat &lt;&lt;EOF &gt;&gt;infra/watcher/kube.cue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment: watcher: spec: template: spec: containers: [{ ports: [{_export: false}, _] }]
</span></span><span style="display:flex;"><span>EOF</span></span></code></pre></div></div>
</div>
<p>In practice it would be more proper form to add this field in the original
port declaration.</p>
<p>We verify that all changes are acceptable and store another snapshot.
Then we run trim to further reduce our configuration:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIHRyaW0gLi8uLi4KZmluZCAuIHwgZ3JlcCBrdWJlLmN1ZSB8IHhhcmdzIHdjIC1sIHwgdGFpbCAtMQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue trim ./...
</span></span><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span> 1212 total</span></span></code></pre></div></div>
</div>
<p>This is after removing the rewritten and now redundant deployment definition.</p>
<p>We shaved off almost another 100 lines, even after adding the template.
You can verify that the service definitions are now gone in most of the files.
What remains is either some additional configuration, or inconsistencies that
should probably be cleaned up.</p>
<p>But we have another trick up our sleeve.
With the <code>-s</code> or <code>--simplify</code> option we can tell <code>trim</code> or <code>fmt</code> to collapse
structs with a single element onto a single line. For instance:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="aGVhZCBmcm9udGVuZC9icmVhZGRpc3BhdGNoZXIva3ViZS5jdWU=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ head frontend/breaddispatcher/kube.cue
</span></span><span style="display:flex;"><span>package kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service: breaddispatcher: {
</span></span><span style="display:flex;"><span>	spec: {
</span></span><span style="display:flex;"><span>		ports: [{}]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>deployment: breaddispatcher: {
</span></span><span style="display:flex;"><span>	spec: {
</span></span><span style="display:flex;"><span>		template: {</span></span></code></pre></div></div>
</div>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIHRyaW0gLi8uLi4gLXMKaGVhZCBmcm9udGVuZC9icmVhZGRpc3BhdGNoZXIva3ViZS5jdWU=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue trim ./... -s
</span></span><span style="display:flex;"><span>$ head frontend/breaddispatcher/kube.cue
</span></span><span style="display:flex;"><span>package kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service: breaddispatcher: spec: ports: [{}]
</span></span><span style="display:flex;"><span>deployment: breaddispatcher: spec: template: {
</span></span><span style="display:flex;"><span>	metadata: annotations: {
</span></span><span style="display:flex;"><span>		&#34;prometheus.io.scrape&#34;: &#34;true&#34;
</span></span><span style="display:flex;"><span>		&#34;prometheus.io.port&#34;:   &#34;7080&#34;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	spec: containers: [{
</span></span><span style="display:flex;"><span>		image: &#34;gcr.io/myproj/breaddispatcher:v0.3.24&#34;</span></span></code></pre></div></div>
</div>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ZmluZCAuIHwgZ3JlcCBrdWJlLmN1ZSB8IHhhcmdzIHdjIC1sIHwgdGFpbCAtMQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span> 1020 total</span></span></code></pre></div></div>
</div>
<p>Another 150 lines lost!
Collapsing lines like this can improve the readability of a configuration
by removing considerable amounts of punctuation.</p>
<p>We save the result as the new baseline:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90MgpjcCBzbmFwc2hvdDIgc25hcHNob3Q=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ cp snapshot2 snapshot</span></span></code></pre></div></div>
</div>
<h3 id="repeat-for-several-subdirectories">
    <a href="#repeat-for-several-subdirectories" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Repeat for several subdirectories</h3>
<p>In the previous section we defined templates for services and deployments
in the root of our directory structure to capture the common traits of all
services and deployments.
In addition, we defined a directory-specific label.
In this section we will look into generalizing the objects per directory.</p>
<h4 id="directory-frontend">
    <a href="#directory-frontend" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Directory <code>frontend</code></h4>
<p>We observe that all deployments in subdirectories of <code>frontend</code>
have a single container with one port,
which is usually <code>7080</code>, but sometimes <code>8080</code>.
Also, most have two prometheus-related annotations, while some have one.
We leave the inconsistencies in ports, but add both annotations
unconditionally.</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/frontend/kube2.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/frontend/kube2.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/frontend/kube2.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/frontend/kube2.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpkZXBsb3ltZW50OiBbc3RyaW5nXTogc3BlYzogdGVtcGxhdGU6IHsKCW1ldGFkYXRhOiBhbm5vdGF0aW9uczogewoJCSJwcm9tZXRoZXVzLmlvLnNjcmFwZSI6ICJ0cnVlIgoJCSJwcm9tZXRoZXVzLmlvLnBvcnQiOiAgICJcKHNwZWMuY29udGFpbmVyc1swXS5wb3J0c1swXS5jb250YWluZXJQb3J0KSIKCX0KCXNwZWM6IGNvbnRhaW5lcnM6IFt7CgkJcG9ydHM6IFt7Y29udGFpbmVyUG9ydDogKjcwODAgfCBpbnR9XSAvLyA3MDgwIGlzIHRoZSBkZWZhdWx0Cgl9XQp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">]:</span> spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> annotations<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#b84">&#34;prometheus.io.scrape&#34;</span><span style="font-weight:bold">:</span> <span style="color:#b84">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#b84">&#34;prometheus.io.port&#34;</span><span style="font-weight:bold">:</span>   <span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>spec.containers<span style="font-weight:bold">[</span><span style="color:#099">0</span><span style="font-weight:bold">]</span>.ports<span style="font-weight:bold">[</span><span style="color:#099">0</span><span style="font-weight:bold">]</span>.containerPort<span style="color:#b84">)</span><span style="color:#b84">&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>		ports<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{containerPort<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#099">7080</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">int</span>}<span style="font-weight:bold">]</span> <span style="color:#998;font-style:italic">// 7080 is the default</span>
</span></span><span style="display:flex;"><span>	}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90MgpkaWZmIC13dSBzbmFwc2hvdCBzbmFwc2hvdDIgLS1sYWJlbCBzbmFwc2hvdCAtLWxhYmVsIHNuYXBzaG90MgpjcCBzbmFwc2hvdDIgc25hcHNob3Q=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
</span></span><span style="display:flex;"><span>--- snapshot
</span></span><span style="display:flex;"><span>+++ snapshot2
</span></span><span style="display:flex;"><span>@@ -170,6 +170,7 @@
</span></span><span style="display:flex;"><span>                 metadata: {
</span></span><span style="display:flex;"><span>                     annotations: {
</span></span><span style="display:flex;"><span>                         &#34;prometheus.io.scrape&#34;: &#34;true&#34;
</span></span><span style="display:flex;"><span>+                        &#34;prometheus.io.port&#34;:   &#34;7080&#34;
</span></span><span style="display:flex;"><span>                     }
</span></span><span style="display:flex;"><span>                     labels: {
</span></span><span style="display:flex;"><span>                         app:       &#34;host&#34;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>$ cp snapshot2 snapshot</span></span></code></pre></div></div>
</div>
<p>Two lines with annotations added, improving consistency.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIHRyaW0gLi9mcm9udGVuZC8uLi4gLXMKZmluZCAuIHwgZ3JlcCBrdWJlLmN1ZSB8IHhhcmdzIHdjIC1sIHwgdGFpbCAtMQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue trim ./frontend/... -s
</span></span><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span> 1005 total</span></span></code></pre></div></div>
</div>
<p>Another 40 odd lines removed.
We may have gotten used to larger reductions, but at this point there is just
not much left to remove: in some of the frontend files there are only 4 lines
of configuration left.</p>
<p>We save the result as the new baseline:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGV2YWwgLWMgLi8uLi4gPnNuYXBzaG90MgpjcCBzbmFwc2hvdDIgc25hcHNob3Q=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ cp snapshot2 snapshot</span></span></code></pre></div></div>
</div>
<h4 id="directory-kitchen">
    <a href="#directory-kitchen" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Directory <code>kitchen</code></h4>
<p>In this directory we observe that all deployments have without exception
one container with port <code>8080</code>, all have the same liveness probe,
a single line of prometheus annotation, and most have
two or three disks with similar patterns.</p>
<p>Let&rsquo;s add everything but the disks for now:</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kitchen/kube2.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kitchen/kube2.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kitchen/kube2.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kitchen/kube2.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpkZXBsb3ltZW50OiBbc3RyaW5nXTogc3BlYzogdGVtcGxhdGU6IHsKCW1ldGFkYXRhOiBhbm5vdGF0aW9uczogInByb21ldGhldXMuaW8uc2NyYXBlIjogInRydWUiCglzcGVjOiBjb250YWluZXJzOiBbewoJCXBvcnRzOiBbewoJCQljb250YWluZXJQb3J0OiA4MDgwCgkJfV0KCQlsaXZlbmVzc1Byb2JlOiB7CgkJCWh0dHBHZXQ6IHsKCQkJCXBhdGg6ICIvZGVidWcvaGVhbHRoIgoJCQkJcG9ydDogODA4MAoJCQl9CgkJCWluaXRpYWxEZWxheVNlY29uZHM6IDQwCgkJCXBlcmlvZFNlY29uZHM6ICAgICAgIDMKCQl9Cgl9XQp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">]:</span> spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	metadata<span style="font-weight:bold">:</span> annotations<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;prometheus.io.scrape&#34;</span><span style="font-weight:bold">:</span> <span style="color:#b84">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>	spec<span style="font-weight:bold">:</span> containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>		ports<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>			containerPort<span style="font-weight:bold">:</span> <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>		}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		livenessProbe<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>			httpGet<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>				path<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;/debug/health&#34;</span>
</span></span><span style="display:flex;"><span>				port<span style="font-weight:bold">:</span> <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			initialDelaySeconds<span style="font-weight:bold">:</span> <span style="color:#099">40</span>
</span></span><span style="display:flex;"><span>			periodSeconds<span style="font-weight:bold">:</span>       <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<p>A diff reveals that one prometheus annotation was added to a service.
We assume this to be an accidental omission and accept the differences</p>
<p>Disks need to be defined in both the template spec section as well as in
the container where they are used.
We prefer to keep these two definitions together.
We take the volumes definition from <code>expiditer</code> (the first config in that
directory with two disks), and generalize it:</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kitchen/kube3.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kitchen/kube3.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kitchen/kube3.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kitchen/kube3.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpkZXBsb3ltZW50OiBbSUQ9X106IHNwZWM6IHRlbXBsYXRlOiBzcGVjOiB7CglfaGFzRGlza3M6ICp0cnVlIHwgYm9vbAoKCS8vIGZpZWxkIGNvbXByZWhlbnNpb24gdXNpbmcganVzdCAiaWYiCglpZiBfaGFzRGlza3MgewoJCXZvbHVtZXM6IFt7CgkJCW5hbWU6ICoiXChJRCktZGlzayIgfCBzdHJpbmcKCQkJZ2NlUGVyc2lzdGVudERpc2s6IHBkTmFtZTogKiJcKElEKS1kaXNrIiB8IHN0cmluZwoJCQlnY2VQZXJzaXN0ZW50RGlzazogZnNUeXBlOiAiZXh0NCIKCQl9LCB7CgkJCW5hbWU6ICoic2VjcmV0LVwoSUQpIiB8IHN0cmluZwoJCQlzZWNyZXQ6IHNlY3JldE5hbWU6ICoiXChJRCktc2VjcmV0cyIgfCBzdHJpbmcKCQl9LCAuLi5dCgoJCWNvbnRhaW5lcnM6IFt7CgkJCXZvbHVtZU1vdW50czogW3sKCQkJCW5hbWU6ICAgICAgKiJcKElEKS1kaXNrIiB8IHN0cmluZwoJCQkJbW91bnRQYXRoOiAqIi9sb2dzIiB8IHN0cmluZwoJCQl9LCB7CgkJCQltb3VudFBhdGg6ICoiL2V0Yy9jZXJ0cyIgfCBzdHJpbmcKCQkJCW5hbWU6ICAgICAgKiJzZWNyZXQtXChJRCkiIHwgc3RyaW5nCgkJCQlyZWFkT25seTogIHRydWUKCQkJfSwgLi4uXQoJCX1dCgl9Cn0=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>ID<span style="font-weight:bold">=</span><span style="font-weight:bold">_</span><span style="font-weight:bold">]:</span> spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> spec<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	_hasDisks<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="font-weight:bold">true</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// field comprehension using just &#34;if&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">if</span> _hasDisks {
</span></span><span style="display:flex;"><span>		volumes<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>			name<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">-disk&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>			gcePersistentDisk<span style="font-weight:bold">:</span> pdName<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">-disk&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>			gcePersistentDisk<span style="font-weight:bold">:</span> fsType<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;ext4&#34;</span>
</span></span><span style="display:flex;"><span>		}<span style="font-weight:bold">,</span> {
</span></span><span style="display:flex;"><span>			name<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;secret-</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>			secret<span style="font-weight:bold">:</span> secretName<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">-secrets&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>		}<span style="font-weight:bold">,</span> <span style="font-weight:bold">...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		containers<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>			volumeMounts<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>{
</span></span><span style="display:flex;"><span>				name<span style="font-weight:bold">:</span>      <span style="font-weight:bold">*</span><span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">-disk&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>				mountPath<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;/logs&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>			}<span style="font-weight:bold">,</span> {
</span></span><span style="display:flex;"><span>				mountPath<span style="font-weight:bold">:</span> <span style="font-weight:bold">*</span><span style="color:#b84">&#34;/etc/certs&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>				name<span style="font-weight:bold">:</span>      <span style="font-weight:bold">*</span><span style="color:#b84">&#34;secret-</span><span style="color:#b84">\(</span>ID<span style="color:#b84">)</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">|</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>				readOnly<span style="font-weight:bold">:</span>  <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			}<span style="font-weight:bold">,</span> <span style="font-weight:bold">...]</span>
</span></span><span style="display:flex;"><span>		}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kitchen/souschef/kube2.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kitchen/souschef/kube2.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kitchen/souschef/kube2.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kitchen/souschef/kube2.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpkZXBsb3ltZW50OiBzb3VzY2hlZjogc3BlYzogdGVtcGxhdGU6IHNwZWM6IHsKCV9oYXNEaXNrczogZmFsc2UKfQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment<span style="font-weight:bold">:</span> souschef<span style="font-weight:bold">:</span> spec<span style="font-weight:bold">:</span> template<span style="font-weight:bold">:</span> spec<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	_hasDisks<span style="font-weight:bold">:</span> <span style="font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<p>This template definition is not ideal: the definitions are positional, so if
configurations were to define the disks in a different order, there would be
no reuse or even conflicts.
Also note that in order to deal with this restriction, almost all field values
are just default values and can be overridden by instances.
A better way would be define a map of volumes,
similarly to how we organized the top-level Kubernetes objects,
and then generate these two sections from this map.
This requires some design, though, and does not belong in a
&ldquo;quick-and-dirty&rdquo; tutorial.
Later in this document we introduce a manually optimized configuration.</p>
<p>We add the two disk by default and define a <code>_hasDisks</code> option to opt out.
The <code>souschef</code> configuration is the only one that defines no disks.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIHRyaW0gLXMgLi9raXRjaGVuLy4uLgpjdWUgZXZhbCAtYyAuLy4uLiA&#43;c25hcHNob3QyCmRpZmYgLXd1IHNuYXBzaG90IHNuYXBzaG90MiAtLWxhYmVsIHNuYXBzaG90IC0tbGFiZWwgc25hcHNob3QyCmNwIHNuYXBzaG90MiBzbmFwc2hvdApmaW5kIC4gfCBncmVwIGt1YmUuY3VlIHwgeGFyZ3Mgd2MgLWwgfCB0YWlsIC0x">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue trim -s ./kitchen/...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># check differences
</span></span><span style="display:flex;"><span>$ cue eval -c ./... &gt;snapshot2
</span></span><span style="display:flex;"><span>$ diff -wu snapshot snapshot2 --label snapshot --label snapshot2
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>$ cp snapshot2 snapshot
</span></span><span style="display:flex;"><span>$ find . | grep kube.cue | xargs wc -l | tail -1
</span></span><span style="display:flex;"><span>  997 total</span></span></code></pre></div></div>
</div>
<p>The diff shows that we added the <code>_hasDisks</code> option, but otherwise reveals no
differences.
We also reduced the configuration by a sizeable amount once more.</p>
<p>However, on closer inspection of the remaining files we see a lot of remaining
fields in the disk specifications as a result of inconsistent naming.
Reducing configurations like we did in this exercise exposes inconsistencies.
The inconsistencies can be removed by simply deleting the overrides in the
specific configuration.
Leaving them as is gives a clear signal that a configuration is inconsistent.</p>
<h3 id="conclusion-of-quick-n-dirty-tutorial">
    <a href="#conclusion-of-quick-n-dirty-tutorial" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Conclusion of Quick &rsquo;n Dirty tutorial</h3>
<p>There is still some gain to be made with the other directories.
At nearly a 1000-line, or 55%, reduction, we leave the rest as an exercise to
the reader.</p>
<p>We have shown how CUE can be used to reduce boilerplate, enforce consistencies,
and detect inconsistencies.
Being able to deal with consistencies and inconsistencies is a consequence of
the constraint-based model and harder to do with inheritance-based languages.</p>
<p>We have indirectly also shown how CUE is well-suited for machine manipulation.
This is a factor of syntax and the order independence that follows from its
semantics.
The <code>trim</code> command is one of many possible automated refactor tools made
possible by this property.
Also this would be harder to do with inheritance-based configuration languages.</p>
<h2 id="define-commands">
    <a href="#define-commands" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Define commands</h2>
<p>The <code>cue export</code> command can be used to convert the created configuration back
to JSON.
In our case, this requires a top-level &ldquo;emit value&rdquo;
to convert our mapped Kubernetes objects back to a list.
Typically, this output is piped to tools like <code>kubectl</code> or <code>etcdctl</code>.</p>
<p>In practice this means typing the same commands ad nauseam.
The next step is often to write wrapper tools.
But as there is often no one-size-fits-all solution, this lead to the
proliferation of marginally useful tools.
The <code>cue</code> tool provides an alternative by allowing the declaration of
frequently used commands in CUE itself.
Advantages:</p>
<ul>
<li>added domain knowledge that CUE may use for improved analysis,</li>
<li>only one language to learn,</li>
<li>easy discovery of commands,</li>
<li>no further configuration required,</li>
<li>enforce uniform CLI standards across commands,</li>
<li>standardized commands across an organization.</li>
</ul>
<p>Commands are defined in files ending with <code>_tool.cue</code> in the same package as
where the configuration files are defined on which the commands should operate.
Top-level values in the configuration are visible by the tool files
as long as they are not shadowed by top-level fields in the tool files.
Top-level fields in the tool files are not visible in the configuration files
and are not part of any model.</p>
<p>The tool definitions also have access to additional builtin packages.
A CUE configuration is fully hermetic, disallowing any outside influence.
This property enables automated analysis and manipulation
such as the <code>trim</code> command.
The tool definitions, however, have access to such things as command line flags
and environment variables, random generators, file listings, and so on.</p>
<p>We define the following tools for our example:</p>
<ul>
<li>ls: list the Kubernetes objects defined in our configuration</li>
<li>dump: dump all selected objects as a YAML stream</li>
<li>create: send all selected objects to <code>kubectl</code> for creation</li>
</ul>
<h3 id="preparations">
    <a href="#preparations" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Preparations</h3>
<p>To work with Kubernetes we need to convert our map of Kubernetes objects
back to a simple list.
We create the tool file to do just that.</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/kube_tool.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/kube_tool.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/kube_tool.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/kube_tool.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgpvYmplY3RzOiBbZm9yIHYgaW4gb2JqZWN0U2V0cyBmb3IgeCBpbiB2IHt4fV0KCm9iamVjdFNldHM6IFsKCXNlcnZpY2UsCglkZXBsb3ltZW50LAoJc3RhdGVmdWxTZXQsCglkYWVtb25TZXQsCgljb25maWdNYXAsCl0=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objects<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span><span style="font-weight:bold">for</span> v <span style="font-weight:bold">in</span> objectSets <span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> v {x}<span style="font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objectSets<span style="font-weight:bold">:</span> <span style="font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>	service<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	deployment<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	statefulSet<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	daemonSet<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	configMap<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">]</span></span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<h3 id="listing-objects">
    <a href="#listing-objects" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Listing objects</h3>
<p>Commands are defined in the <code>command</code> section at the top-level of a tool file.
A <code>cue</code> command defines command line flags, environment variables, as well as
a set of tasks.
Examples tasks are load or write a file, dump something to the console,
download a web page, or execute a command.</p>
<p>We start by defining the <code>ls</code> command which dumps all our objects</p>
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/ls_tool.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/ls_tool.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/ls_tool.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/ls_tool.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgppbXBvcnQgKAoJInRleHQvdGFid3JpdGVyIgoJInRvb2wvY2xpIgoJInRvb2wvZmlsZSIKKQoKY29tbWFuZDogbHM6IHsKCXRhc2s6IHByaW50OiBjbGkuUHJpbnQgJiB7CgkJdGV4dDogdGFid3JpdGVyLldyaXRlKFsKCQkJZm9yIHggaW4gb2JqZWN0cyB7CgkJCQkiXCh4LmtpbmQpICBcdFwoeC5tZXRhZGF0YS5sYWJlbHMuY29tcG9uZW50KSAgXHRcKHgubWV0YWRhdGEubmFtZSkiCgkJCX0sCgkJXSkKCX0KCgl0YXNrOiB3cml0ZTogZmlsZS5DcmVhdGUgJiB7CgkJZmlsZW5hbWU6ICJmb28udHh0IgoJCWNvbnRlbnRzOiB0YXNrLnByaW50LnRleHQKCX0KfQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;text/tabwriter&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;tool/cli&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;tool/file&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>command<span style="font-weight:bold">:</span> ls<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	task<span style="font-weight:bold">:</span> print<span style="font-weight:bold">:</span> cli.Print <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>		text<span style="font-weight:bold">:</span> tabwriter.Write(<span style="font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> objects {
</span></span><span style="display:flex;"><span>				<span style="color:#b84">&#34;</span><span style="color:#b84">\(</span>x.kind<span style="color:#b84">)</span><span style="color:#b84">  </span><span style="color:#b84">\t</span><span style="color:#b84">\(</span>x.metadata.labels.component<span style="color:#b84">)</span><span style="color:#b84">  </span><span style="color:#b84">\t</span><span style="color:#b84">\(</span>x.metadata.name<span style="color:#b84">)</span><span style="color:#b84">&#34;</span>
</span></span><span style="display:flex;"><span>			}<span style="font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">]</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	task<span style="font-weight:bold">:</span> write<span style="font-weight:bold">:</span> file.Create <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>		filename<span style="font-weight:bold">:</span> <span style="color:#b84">&#34;foo.txt&#34;</span>
</span></span><span style="display:flex;"><span>		contents<span style="font-weight:bold">:</span> task.print.text
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<!-- TODO: use "let" once implemented-->
<p>NOTE: THE API OF THE TASK DEFINITIONS WILL CHANGE.
Although we may keep supporting this form if needed.</p>
<p>The command is now available in the <code>cue</code> tool:</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGNtZCBscyAuL2Zyb250ZW5kL21haXRyZWQ=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue cmd ls ./frontend/maitred
</span></span><span style="display:flex;"><span>Service      frontend   maitred
</span></span><span style="display:flex;"><span>Deployment   frontend   maitred</span></span></code></pre></div></div>
</div>
<p>If more than one instance is selected the <code>cue</code> tool may either operate
on them one by one or merge them.
The default is to merge them.
Different instances of a package are typically not compatible:
different subdirectories may have different specializations.
A merge pre-expands templates of each instance and then merges their root
values.
The result may contain conflicts, such as our top-level <code>#Component</code> field,
but our per-type maps of Kubernetes objects should be free of conflict
(if there is, we have a problem with Kubernetes down the line).
A merge thus gives us a unified view of all objects.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGNtZCBscyAuLy4uLg==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue cmd ls ./...
</span></span><span style="display:flex;"><span>Service       frontend   bartender
</span></span><span style="display:flex;"><span>Service       frontend   breaddispatcher
</span></span><span style="display:flex;"><span>Service       frontend   host
</span></span><span style="display:flex;"><span>Service       frontend   maitred
</span></span><span style="display:flex;"><span>Service       frontend   valeter
</span></span><span style="display:flex;"><span>Service       frontend   waiter
</span></span><span style="display:flex;"><span>Service       frontend   waterdispatcher
</span></span><span style="display:flex;"><span>Service       infra      download
</span></span><span style="display:flex;"><span>Service       infra      etcd
</span></span><span style="display:flex;"><span>Service       infra      events
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<h3 id="dumping-a-yaml-stream">
    <a href="#dumping-a-yaml-stream" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Dumping a YAML Stream</h3>
<p>The following adds a command to dump the selected objects as a YAML stream.</p>
<!--
TODO: add command line flags to filter object types.
-->
<div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/dump_tool.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/dump_tool.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/dump_tool.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/dump_tool.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgppbXBvcnQgKAoJImVuY29kaW5nL3lhbWwiCgkidG9vbC9jbGkiCikKCmNvbW1hbmQ6IGR1bXA6IHsKCXRhc2s6IHByaW50OiBjbGkuUHJpbnQgJiB7CgkJdGV4dDogeWFtbC5NYXJzaGFsU3RyZWFtKG9iamVjdHMpCgl9Cn0=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;encoding/yaml&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;tool/cli&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>command<span style="font-weight:bold">:</span> dump<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	task<span style="font-weight:bold">:</span> print<span style="font-weight:bold">:</span> cli.Print <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>		text<span style="font-weight:bold">:</span> yaml.MarshalStream(objects)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

<!--
TODO: with new API as well as conversions implemented
command dump task print: cli.Print(text: yaml.MarshalStream(objects))

or without conversions:
command dump task print: cli.Print & {text: yaml.MarshalStream(objects)}
-->
<p>The <code>MarshalStream</code> command converts the list of objects to a &lsquo;<code>---</code>&rsquo;-separated
stream of YAML values.</p>
<h3 id="creating-objects">
    <a href="#creating-objects" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Creating Objects</h3>
<p>The <code>create</code> command sends a list of objects to <code>kubectl create</code>.</p>
<p><div class="code-tabs"><div class="code-tabs__item code-tabs__item--top-left">




<div class="tabs tabs--code" data-tabs data-group="default">
<div class="tabs__nav tabs-nav tabs-nav--code" data-tabs-nav><div class="tabs-nav__item">
            <div
                data-tab-item="tmp/services/create_tool.cue"
                data-tab-group="default"
                class="tabs-nav__tab"data-copy><button title="Copy filename" class="tabs-nav__copy" data-copy-button data-copy-type="text" data-copy-value="tmp/services/create_tool.cue">



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--file"></use>
</svg>
<span class="tabs-nav__message is-hidden" data-copy-message aria-hidden="true">
                            Copied!
                        </span>
                    </button>tmp/services/create_tool.cue
            </div>
        </div></div>

<div class="tabs__content"><div data-tab-item="tmp/services/create_tool.cue"
            data-tab-group="default"
            class="tabs__item is-active"
        ><div class="code-block code-block--tab"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="cGFja2FnZSBrdWJlCgppbXBvcnQgKAoJImVuY29kaW5nL3lhbWwiCgkidG9vbC9leGVjIgoJInRvb2wvY2xpIgopCgpjb21tYW5kOiBjcmVhdGU6IHsKCXRhc2s6IGt1YmU6IGV4ZWMuUnVuICYgewoJCWNtZDogICAgImt1YmVjdGwgY3JlYXRlIC0tZHJ5LXJ1bj1jbGllbnQgLWYgLSIKCQlzdGRpbjogIHlhbWwuTWFyc2hhbFN0cmVhbShvYmplY3RzKQoJCXN0ZG91dDogc3RyaW5nCgl9CgoJdGFzazogZGlzcGxheTogY2xpLlByaW50ICYgewoJCXRleHQ6IHRhc2sua3ViZS5zdGRvdXQKCX0KfQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cue" data-lang="cue"><span style="display:flex;"><span><span style="font-weight:bold">package</span> kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;encoding/yaml&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;tool/exec&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#b84">&#34;tool/cli&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>command<span style="font-weight:bold">:</span> create<span style="font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>	task<span style="font-weight:bold">:</span> kube<span style="font-weight:bold">:</span> exec.Run <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>		cmd<span style="font-weight:bold">:</span>    <span style="color:#b84">&#34;kubectl create --dry-run=client -f -&#34;</span>
</span></span><span style="display:flex;"><span>		stdin<span style="font-weight:bold">:</span>  yaml.MarshalStream(objects)
</span></span><span style="display:flex;"><span>		stdout<span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	task<span style="font-weight:bold">:</span> display<span style="font-weight:bold">:</span> cli.Print <span style="font-weight:bold">&amp;</span> {
</span></span><span style="display:flex;"><span>		text<span style="font-weight:bold">:</span> task.kube.stdout
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
</div>
</div></div>
</div>

</div></div>

This command has two tasks, named <code>kube</code> and <code>display</code>.
The <code>display</code> task depends on the output of the <code>kube</code> task.
The <code>cue</code> tool does a static analysis of the dependencies and runs all
tasks which dependencies are satisfied in parallel while blocking tasks
for which an input is missing.</p>
<div class="code-block code-block--heading code-block--terminal"data-copy><div class="code-block__heading">
            <span class="code-block__tab">TERMINAL</span>
        </div><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGNtZCBjcmVhdGUgLi9mcm9udGVuZC8uLi4=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cue cmd create ./frontend/...
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: bartender
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: bartender
</span></span><span style="display:flex;"><span>    domain: prod
</span></span><span style="display:flex;"><span>    component: frontend
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div></div>
</div>
<p>A production real-life version of this could should omit the <code>--dry-run=client</code> flag
of course.</p>
<h3 id="extract-cue-templates-directly-from-kubernetes-go-source">
    <a href="#extract-cue-templates-directly-from-kubernetes-go-source" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Extract CUE templates directly from Kubernetes Go source</h3>
<p>In order for <code>cue get go</code> to generate the CUE templates from Go sources, you first need to have the sources locally:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="JCBnbyBnZXQgazhzLmlvL2FwaS9hcHBzL3YxQHYwLjIzLjQKJCBjdWUgZ2V0IGdvIGs4cy5pby9hcGkvYXBwcy92MQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>$ go get k8s.io/api/apps/v1@v0.23.4
$ cue get go k8s.io/api/apps/v1</code></pre></div>
</div>
<p>Now that we have the Kubernetes definitions in our module, we can import and use them:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="JCBjYXQgPDxFT0YgPiBrOHNfZGVmcy5jdWUKcGFja2FnZSBrdWJlCgppbXBvcnQgKAoJIms4cy5pby9hcGkvY29yZS92MSIKCWFwcHNfdjEgIms4cy5pby9hcGkvYXBwcy92MSIKKQoKc2VydmljZTogW3N0cmluZ106ICAgICB2MS4jU2VydmljZQpkZXBsb3ltZW50OiBbc3RyaW5nXTogIGFwcHNfdjEuI0RlcGxveW1lbnQKZGFlbW9uU2V0OiBbc3RyaW5nXTogICBhcHBzX3YxLiNEYWVtb25TZXQKc3RhdGVmdWxTZXQ6IFtzdHJpbmddOiBhcHBzX3YxLiNTdGF0ZWZ1bFNldApFT0Y=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>$ cat &lt;&lt;EOF &gt; k8s_defs.cue
package kube

import (
	&#34;k8s.io/api/core/v1&#34;
	apps_v1 &#34;k8s.io/api/apps/v1&#34;
)

service: [string]:     v1.#Service
deployment: [string]:  apps_v1.#Deployment
daemonSet: [string]:   apps_v1.#DaemonSet
statefulSet: [string]: apps_v1.#StatefulSet
EOF</code></pre></div>
</div>
<p>And, finally, we&rsquo;ll format again:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Y3VlIGZtdA==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>cue fmt</code></pre></div>
</div>
<h2 id="manually-tailored-configuration">
    <a href="#manually-tailored-configuration" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Manually tailored configuration</h2>
<p>In Section &ldquo;Quick &rsquo;n Dirty&rdquo; we showed how to quickly get going with CUE.
With a bit more deliberation, one can reduce configurations even further.
Also, we would like to define a configuration that is more generic and less tied
to Kubernetes.</p>
<p>We will rely heavily on CUEs order independence, which makes it easy to
combine two configurations of the same object in a well-defined way.
This makes it easy, for instance, to put frequently used fields in one file
and more esoteric one in another and then combine them without fear that one
will override the other.
We will take this approach in this section.</p>
<p>The end result of this tutorial is in the <code>manual</code> directory.
In the next sections we will show how to get there.</p>
<h3 id="outline">
    <a href="#outline" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Outline</h3>
<p>The basic premise of our configuration is to maintain two configurations,
a simple and abstract one, and one compatible with Kubernetes.
The Kubernetes version is automatically generated from the simple configuration.
Each simplified object has a <code>kubernetes</code> section that get gets merged into
the Kubernetes object upon conversion.</p>
<p>We define one top-level file with our generic definitions.</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Ly8gZmlsZSBjbG91ZC5jdWUKcGFja2FnZSBjbG91ZAoKc2VydmljZTogW05hbWU9X106IHsKICAgIG5hbWU6ICpOYW1lIHwgc3RyaW5nIC8vIHRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlCgogICAgLi4uCgogICAgLy8gS3ViZXJuZXRlcy1zcGVjaWZpYyBvcHRpb25zIHRoYXQgZ2V0IG1peGVkIGluIHdoZW4gY29udmVydGluZwogICAgLy8gdG8gS3ViZXJuZXRlcy4KICAgIGt1YmVybmV0ZXM6IHsKICAgIH0KfQoKZGVwbG95bWVudDogW05hbWU9X106IHsKICAgIG5hbWU6ICpOYW1lIHwgc3RyaW5nCiAgIC4uLgp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>// file cloud.cue
package cloud

service: [Name=_]: {
    name: *Name | string // the name of the service

    ...

    // Kubernetes-specific options that get mixed in when converting
    // to Kubernetes.
    kubernetes: {
    }
}

deployment: [Name=_]: {
    name: *Name | string
   ...
}</code></pre></div>
</div>
<p>A Kubernetes-specific file then contains the definitions to
convert the generic objects to Kubernetes.</p>
<p>Overall, the code modeling our services and the code generating the kubernetes
code is separated, while still allowing to inject Kubernetes-specific
data into our general model.
At the same time, we can add additional information to our model without
it ending up in the Kubernetes definitions causing it to barf.</p>
<h3 id="deployment-definition">
    <a href="#deployment-definition" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Deployment Definition</h3>
<p>For our design we assume that all Kubernetes Pod derivatives only define one
container.
This is clearly not the case in general, but often it does and it is good
practice.
Conveniently, it simplifies our model as well.</p>
<p>We base the model loosely on the master templates we derived in
Section &ldquo;Quick &rsquo;n Dirty&rdquo;.
The first step we took is to eliminate <code>statefulSet</code> and <code>daemonSet</code> and
rather just have a <code>deployment</code> allowing different kinds.</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ZGVwbG95bWVudDogW05hbWU9X106IF9iYXNlICYgewogICAgbmFtZTogICAgICpOYW1lIHwgc3RyaW5nCiAgICAuLi4=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>deployment: [Name=_]: _base &amp; {
    name:     *Name | string
    ...</code></pre></div>
</div>
<p>The kind only needs to be specified if the deployment is a stateful set or
daemonset.
This also eliminates the need for <code>_spec</code>.</p>
<p>The next step is to pull common fields, such as <code>image</code> to the top level.</p>
<p>Arguments can be specified as a map.</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ICAgIGFyZzogW3N0cmluZ106IHN0cmluZwogICAgYXJnczogW2ZvciBrLCB2IGluIGFyZyB7ICItXChrKT1cKHYpIiB9XSB8IFsuLi5zdHJpbmdd">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>    arg: [string]: string
    args: [for k, v in arg { &#34;-\(k)=\(v)&#34; }] | [...string]</code></pre></div>
</div>
<p>If order matters, users could explicitly specify the list as well.</p>
<p>For ports we define two simple maps from name to port number:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ICAgIC8vIGV4cG9zZSBwb3J0IGRlZmluZXMgbmFtZWQgcG9ydHMgdGhhdCBpcyBleHBvc2VkIGluIHRoZSBzZXJ2aWNlCiAgICBleHBvc2U6IHBvcnQ6IFtzdHJpbmddOiBpbnQKCiAgICAvLyBwb3J0IGRlZmluZXMgYSBuYW1lZCBwb3J0IHRoYXQgaXMgbm90IGV4cG9zZWQgaW4gdGhlIHNlcnZpY2UuCiAgICBwb3J0OiBbc3RyaW5nXTogaW50">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>    // expose port defines named ports that is exposed in the service
    expose: port: [string]: int

    // port defines a named port that is not exposed in the service.
    port: [string]: int</code></pre></div>
</div>
<p>Both maps get defined in the container definition, but only <code>port</code> gets
included in the service definition.
This may not be the best model, and does not support all features,
but it shows how one can chose a different representation.</p>
<p>A similar story holds for environment variables.
In most cases mapping strings to string suffices.
The testdata uses other options though.
We define a simple <code>env</code> map and an <code>envSpec</code> for more elaborate cases:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ICAgIGVudjogW3N0cmluZ106IHN0cmluZwoKICAgIGVudlNwZWM6IFtzdHJpbmddOiB7fQogICAgZW52U3BlYzogewogICAgICAgIGZvciBrLCB2IGluIGVudiB7CiAgICAgICAgICAgICJcKGspIiB2YWx1ZTogdgogICAgICAgIH0KICAgIH0=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>    env: [string]: string

    envSpec: [string]: {}
    envSpec: {
        for k, v in env {
            &#34;\(k)&#34; value: v
        }
    }</code></pre></div>
</div>
<p>The simple map automatically gets mapped into the more elaborate map
which then presents the full picture.</p>
<p>Finally, our assumption that there is one container per deployment allows us
to create a single definition for volumes, combining the information for
volume spec and volume mount.</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="ICAgIHZvbHVtZTogW05hbWU9X106IHsKICAgICAgICBuYW1lOiAgICAgICAqTmFtZSB8IHN0cmluZwogICAgICAgIG1vdW50UGF0aDogIHN0cmluZwogICAgICAgIHN1YlBhdGg6ICAgIG51bGwgfCBzdHJpbmcKICAgICAgICByZWFkT25seTogICBib29sCiAgICAgICAga3ViZXJuZXRlczoge30KICAgIH0=">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>    volume: [Name=_]: {
        name:       *Name | string
        mountPath:  string
        subPath:    null | string
        readOnly:   bool
        kubernetes: {}
    }</code></pre></div>
</div>
<p>All other fields that we way want to define can go into a generic kubernetes
struct that gets merged in with all other generated kubernetes data.
This even allows us to augment generated data, such as adding additional
fields to the container.</p>
<h3 id="service-definition">
    <a href="#service-definition" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Service Definition</h3>
<p>The service definition is straightforward.
As we eliminated stateful and daemon sets, the field comprehension to
automatically derive a service is now a bit simpler:</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="Ly8gZGVmaW5lIHNlcnZpY2VzIGltcGxpZWQgYnkgZGVwbG95bWVudHMKc2VydmljZTogewogICAgZm9yIGssIHNwZWMgaW4gZGVwbG95bWVudCB7CiAgICAgICAgIlwoaykiOiB7CiAgICAgICAgICAgIC8vIENvcHkgb3ZlciBhbGwgcG9ydHMgZXhwb3NlZCBmcm9tIGNvbnRhaW5lcnMuCiAgICAgICAgICAgIGZvciBOYW1lLCBQb3J0IGluIHNwZWMuZXhwb3NlLnBvcnQgewogICAgICAgICAgICAgICAgcG9ydDogIlwoTmFtZSkiOiB7CiAgICAgICAgICAgICAgICAgICAgcG9ydDogICAgICAgKlBvcnQgfCBpbnQKICAgICAgICAgICAgICAgICAgICB0YXJnZXRQb3J0OiAqUG9ydCB8IGludAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb3B5IG92ZXIgdGhlIGxhYmVscwogICAgICAgICAgICBsYWJlbDogc3BlYy5sYWJlbAogICAgICAgIH0KICAgIH0KfQ==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>// define services implied by deployments
service: {
    for k, spec in deployment {
        &#34;\(k)&#34;: {
            // Copy over all ports exposed from containers.
            for Name, Port in spec.expose.port {
                port: &#34;\(Name)&#34;: {
                    port:       *Port | int
                    targetPort: *Port | int
                }
            }

            // Copy over the labels
            label: spec.label
        }
    }
}</code></pre></div>
</div>
<p>The complete top-level model definitions can be found at
<a href="https://review.gerrithub.io/plugins/gitiles/cue-lang/cue/&#43;/refs/heads/master/doc/tutorial/kubernetes/manual/services/cloud.cue">doc/tutorial/kubernetes/manual/services/cloud.cue</a>.</p>
<p>The tailorings for this specific project (the labels) are defined
<a href="https://review.gerrithub.io/plugins/gitiles/cue-lang/cue/&#43;/refs/heads/master/doc/tutorial/kubernetes/manual/services/kube.cue">here</a>.</p>
<h3 id="converting-to-kubernetes">
    <a href="#converting-to-kubernetes" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Converting to Kubernetes</h3>
<p>Converting services is fairly straightforward.</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="a3ViZXJuZXRlczogc2VydmljZXM6IHsKICAgIGZvciBrLCB4IGluIHNlcnZpY2UgewogICAgICAgICJcKGspIjogeC5rdWJlcm5ldGVzICYgewogICAgICAgICAgICBhcGlWZXJzaW9uOiAidjEiCiAgICAgICAgICAgIGtpbmQ6ICAgICAgICJTZXJ2aWNlIgoKICAgICAgICAgICAgbWV0YWRhdGE6IG5hbWU6ICAgeC5uYW1lCiAgICAgICAgICAgIG1ldGFkYXRhOiBsYWJlbHM6IHgubGFiZWwKICAgICAgICAgICAgc3BlYzogc2VsZWN0b3I6ICAgeC5sYWJlbAoKICAgICAgICAgICAgc3BlYzogcG9ydHM6IFtmb3IgcCBpbiB4LnBvcnQgeyBwIH1dCiAgICAgICAgfQogICAgfQp9">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>kubernetes: services: {
    for k, x in service {
        &#34;\(k)&#34;: x.kubernetes &amp; {
            apiVersion: &#34;v1&#34;
            kind:       &#34;Service&#34;

            metadata: name:   x.name
            metadata: labels: x.label
            spec: selector:   x.label

            spec: ports: [for p in x.port { p }]
        }
    }
}</code></pre></div>
</div>
<p>We add the Kubernetes boilerplate, map the top-level fields and mix in
the raw <code>kubernetes</code> fields for each service.</p>
<p>Mapping deployments is a bit more involved, though analogous.
The complete definitions for Kubernetes conversions can be found at
<a href="https://review.gerrithub.io/plugins/gitiles/cue-lang/cue/&#43;/refs/heads/master/doc/tutorial/kubernetes/manual/services/k8s.cue">doc/tutorial/kubernetes/manual/services/k8s.cue</a>.</p>
<p>Converting the top-level definitions to concrete Kubernetes code is the hardest
part of this exercise.
That said, most CUE users will never have to resort to this level of CUE
to write configurations.
For instance, none of the files in the subdirectories contain comprehensions,
not even the template files in these directories (such as <code>kitchen/kube.cue</code>).
Furthermore, none of the configuration files in any of the
leaf directories contain string interpolations.</p>
<h3 id="metrics">
    <a href="#metrics" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Metrics</h3>
<p>The fully written out manual configuration can be found in the <code>manual</code>
subdirectory.
Running our usual count yields</p>
<div class="code-block"data-copy><div class="code-block__highlight"><button class="code-block__copy" type="button" data-copy-button data-copy-type="code" data-copy-value="JCBmaW5kIC4gfCBncmVwIGt1YmUuY3VlIHwgeGFyZ3Mgd2MgfCB0YWlsIC0xCiAgICAgNTQyICAgIDExOTAgICAxMTUyMCB0b3RhbA==">
                <span>Copy code</span>
                <span class="code-block__message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button><pre tabindex="0"><code>$ find . | grep kube.cue | xargs wc | tail -1
     542    1190   11520 total</code></pre></div>
</div>
<p>This does not count our conversion templates.
Assuming that the top-level templates are reusable, and if we don&rsquo;t count them
for both approaches, the manual approach shaves off about another 150 lines.
If we count the templates as well, the two approaches are roughly equal.</p>
<h3 id="conclusions-manual-configuration">
    <a href="#conclusions-manual-configuration" class="anchor" aria-label="Anchor">



<svg class="icon anchor__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>
</a>Conclusions Manual Configuration</h3>
<p>We have shown that we can further compact a configuration by manually
optimizing template files.
However, we have also shown that the manual optimization only gives
a marginal benefit with respect to the quick-and-dirty semi-automatic reduction.
The benefits for the manual definition largely lies in the organizational
flexibility one gets.</p>
<p>Manually tailoring your configurations allows creating an abstraction layer
between logical definitions and Kubernetes-specific definitions.
At the same time, CUE&rsquo;s order independence
makes it easy to mix in low-level Kubernetes configuration wherever it is
convenient and applicable.</p>
<p>Manual tailoring also allows us to add our own definitions without breaking
Kubernetes.
This is crucial in defining information relevant to definitions,
but unrelated to Kubernetes, where they belong.</p>
<p>Separating abstract from concrete configuration also allows us to create
difference adaptors for the same configuration.</p>
<!-- TODO:
## Conversion to `docker-compose`
-->

                        
                    </div><footer class="article__footer">
    <div class="article__lastmod">
        <p class="lastmod">
         <a class="lastmod__link" href="https://github.com/cue-lang/cuelang.org/commit/cc85230c039e4a11d0a45fb228e7bafc18ebda99">
                Last modified May 22, 2025</a>
    </p>

    </div>

    <div class="article__footer-meta"><div class="article__share"><details class="share" data-dropdown>
    <summary class="button button--icon button--light-blue share__button">
        



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--share"></use>
</svg>

        <span>Open share options</span>
    </summary>

    <ul class="share__list">
        <li class="share__item" data-copy>
            <button class="share__copy" data-copy-button data-copy-type="url" data-copy-value="/docs/draft/cbe-003_kubernetes_tutorial/">
                



<svg class="icon share__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--link"></use>
</svg>

                <span class="share__link-text">Copy link</span>
                <span class="share__copy-message is-hidden" data-copy-message aria-hidden="true">
                    Copied!
                </span>
            </button>
        </li>

        <li class="share__item">
            <a class="share__link" target="_blank" href="https://twitter.com/intent/tweet?url=/docs/draft/cbe-003_kubernetes_tutorial/&text=%20Source:%20https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial%20In%20this%20tutorial%20we%20show%20how%20to%20convert%20Kubernetes%20configuration%20files%20for%20a%20collection%20of%20microservices.%0aThe%20configuration%20files%20are%20scrubbed%20and%20renamed%20versions%20of%20real-life%20configuration%20files.%20The%20files%20are%20organized%20in%20a%20directory%20hierarchy%20grouping%20related%20services%20in%20subdirectories.%20This%20is%20a%20common%20pattern.%20The%20cue%20tooling%20has%20been%20optimized%20for%20this%20use%20case.%0aIn%20this%20tutorial%20we%20will%20address%20the%20following%20topics:%0a">
                



<svg class="icon share__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-x"></use>
</svg>

                <p><span class="share__link-text">Share on X (Twitter)</span></p>
            </a>
        </li>

        <li class="share__item">
            <a class="share__link" target="_blank"
            href="https://www.linkedin.com/shareArticle?mini=true&url=/docs/draft/cbe-003_kubernetes_tutorial/&summary=%20Source:%20https://github.com/cue-labs/cue-by-example/tree/main/003_kubernetes_tutorial%20In%20this%20tutorial%20we%20show%20how%20to%20convert%20Kubernetes%20configuration%20files%20for%20a%20collection%20of%20microservices.%0aThe%20configuration%20files%20are%20scrubbed%20and%20renamed%20versions%20of%20real-life%20configuration%20files.%20The%20files%20are%20organized%20in%20a%20directory%20hierarchy%20grouping%20related%20services%20in%20subdirectories.%20This%20is%20a%20common%20pattern.%20The%20cue%20tooling%20has%20been%20optimized%20for%20this%20use%20case.%0aIn%20this%20tutorial%20we%20will%20address%20the%20following%20topics:%0a">
                



<svg class="icon share__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-linkedin"></use>
</svg>

                <p><span class="share__link-text">Share on Linkedin</span></p>
            </a>
        </li>
    </ul>
</details>
</div>
    </div>
</footer>
</div>
            </article>

            



<div class="prevnext">
    <nav class="prevnext__container" aria-label="Previous/Next navigation"><a class="prevnext__prev" aria-label="Previous" disabled>
                



<svg class="icon prevnext__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--circle-arrow-left"></use>
</svg>

                <span class="prevnext__text">Previous</span>
            </a><a class="prevnext__next" href="/docs/draft/cbe-006_buildkite_importing_pipelines/" aria-label="Next - CUE By Example - Driving Buildkite Pipelines with CUE">
                <span class="prevnext__text">CUE By Example - Driving Buildkite Pipelines with CUE</span>
                



<svg class="icon prevnext__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--circle-arrow-right"></use>
</svg>

            </a></nav>
</div>

        </div>
        <div id="docs-menu" class="docs__aside">
            <div class="docs__backdrop" data-docs-close="docs"></div>
            <div class="docs__nav">
                <nav class="tree">
    <ul class="tree__list is-book">
        
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/introduction/" title="Introduction">
            <span class="tree__text">Introduction</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/tour/" title="Tour">
            <span class="tree__text">Tour</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/integration/" title="Integrations">
            <span class="tree__text">Integrations</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/tutorial/" title="Tutorials">
            <span class="tree__text">Tutorials</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/howto/" title="How-to Guides">
            <span class="tree__text">How-to Guides</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/concept/" title="Concept Guides">
            <span class="tree__text">Concept Guides</span>
        </a>
    </li>
    
    
    

    <li class="tree__item">
        <a class="tree__link" href="/docs/reference/" title="References">
            <span class="tree__text">References</span>
        </a>
    </li>
    </ul>
</nav>



                <button type="button" class="docs__hide button button--icon button--raised button--light-blue"
                        aria-haspopup="menu" aria-expanded="false" aria-controls="docs-menu" data-docs-toggle>



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--chevron-left"></use>
</svg>
<span>Hide side navigation</span>
                </button>
            </div>
        </div>

        <button type="button" class="docs__show button button--icon button--raised button--light-blue"
                aria-haspopup="menu" aria-expanded="false" aria-controls="docs-menu" data-docs-toggle>



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--chevron-right"></use>
</svg>
<span>Show side navigation</span>
        </button>
    </div>

            </main>

            <footer id="site-footer" class="site__footer">
                




<div class="footer">
    <div class="footer__sitemap">
        <nav class="footer__container" aria-label="Footer menu">
            
                
                <div class="nav nav--footer">
                    <p class="nav__title">Get Started</p>

                    <ul class="nav__list">
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/docs/">
                                    <span class="nav__text">Documentation</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/docs/tour/">
                                    <span class="nav__text">Language Tour</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/play/">
                                    <span class="nav__text">Playground</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/docs/introduction/installation/">
                                    <span class="nav__text">Install CUE</span>
                                </a>
                            </li>
                        
                    </ul>
                </div>
            
                
                <div class="nav nav--footer">
                    <p class="nav__title">Community</p>

                    <ul class="nav__list">
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/community">
                                    <span class="nav__text">The CUE Community</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="https://github.com/cue-lang/cue/blob/master/CONTRIBUTING.md#contribution-guide" target="_blank">
                                    <span class="nav__text">Contributing</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/docs/reference/code-of-conduct/">
                                    <span class="nav__text">Code of Conduct</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/s/slack">
                                    <span class="nav__text">Slack Workspace</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="/s/discord">
                                    <span class="nav__text">Discord Server</span>
                                </a>
                            </li>
                        
                    </ul>
                </div>
            
                
                <div class="nav nav--footer">
                    <p class="nav__title">Connect</p>

                    <ul class="nav__list">
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="https://github.com/cue-lang/cue" target="_blank">
                                    <span class="nav__text">GitHub</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="https://twitter.com/cue_lang" target="_blank">
                                    <span class="nav__text">X (Twitter)</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="https://bsky.app/profile/cuelang.org" target="_blank">
                                    <span class="nav__text">Bluesky</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav__item">
                                <a class="nav__link"
                                   href="https://www.youtube.com/@cuelang/videos" target="_blank">
                                    <span class="nav__text">YouTube</span>
                                </a>
                            </li>
                        
                    </ul>
                </div>
            
        </nav>
    </div>

    <div class="footer__legal">
        <nav class="footer__container" aria-label="Legal">
            <div class="nav nav--legal">
                <ul class="nav__list">
                    <li class="nav__item">
                        <span class="nav__text">&copy; 2025 CUE</span>
                    </li>

                    
                        <li class="nav__item"><a class="nav__link"
                               href="/privacy-policy/">
                                <span class="nav__text">Privacy policy</span>
                            </a>
                        </li>
                    

                    <li class="nav__item">
                        <a class="nav__link" href="https://github.com/cue-lang/cue/issues/new?labels=Triage,NeedsInvestigation,cuelang.org&amp;title=cuelang.org:%20&amp;template=bug_report.md&amp;body=%23%23%23&#43;What&#43;page&#43;were&#43;you&#43;looking&#43;at%3F%0A%0A%2Fdocs%2Fdraft%2Fcbe-003_kubernetes_tutorial%2F%0A%0A%23%23%23&#43;What&#43;version&#43;of&#43;the&#43;site&#43;were&#43;you&#43;looking&#43;at%3F%0A%0Ahttps%3A%2F%2Fgithub.com%2Fcue-lang%2Fcuelang.org%2Fcommit%2F64789fe0b723abceb454dfea8fdc748298d590e3%0A%0A%23%23%23&#43;What&#43;did&#43;you&#43;do%3F%0A%0A%0A%0A%23%23%23&#43;What&#43;did&#43;you&#43;expect%3F%0A%0A%0A%0A%23%23%23&#43;What&#43;did&#43;you&#43;see&#43;instead%3F%0A%0A" target="_blank">
                            <span class="nav__text">Report an Issue</span>
                        </a>
                    </li>
                </ul>
            </div>

            <a href="/" class="footer__branding" rel="home">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><path class="logo__letters" d="M39.555 50.355c-6.853.0-11.907 5.133-11.907 13.602s5.027 13.602 11.907 13.602c5.818.0 10.073-3.648 10.94-8.883l-4.034-.012c-.686 3.389-3.532 5.252-6.88 5.252-4.541.0-7.968-3.533-7.968-9.957s3.414-9.955 7.979-9.955c3.373.0 6.207 1.902 6.865 5.328l.004-.002h4.033c-.906-5.664-5.34-8.975-10.94-8.975zm38.748.362-.002.004h.002zm0 .004v26.478H96.07v-3.44H82.297v-8.105h12.752V62.23H82.297V54.16h13.617v-3.44zm-24.823.0v17.521c0 5.974 4.651 9.4 10.51 9.4 5.86.0 10.528-3.426 10.528-9.4V50.721h-3.995v17.457c0 3.711-2.985 5.793-6.529 5.793s-6.517-2.082-6.517-5.793V50.72z"/><path class="logo__inner" d="M64 9.586C33.947 9.586 9.586 33.947 9.586 64S33.947 118.414 64 118.414 118.414 94.053 118.414 64 94.05 9.586 64 9.586zm0 105.973c-28.476.0-51.562-23.086-51.562-51.562S35.524 12.438 64 12.438 115.562 35.524 115.562 64 92.476 115.562 64 115.562z"/><path class="logo__outer" d="M64 0C28.653.0.0 28.653.0 64s28.653 64 64 64 64-28.653 64-64S99.347.0 64 0zm0 121.843C32.054 121.843 6.157 95.946 6.157 64S32.054 6.157 64 6.157 121.843 32.054 121.843 64 95.946 121.843 64 121.843z"/></svg>
                <span>Homepage of CUE</span>
            </a>
        </nav>
    </div>
</div>

            </footer>
        </div>

        
                <div class="notification-bar is-hidden" data-notification-bar="cue-minor-release-v0.13">
        <div class="notification-bar__container">
            <div class="notification-bar__content">
                <strong>CUE v0.13 is now available</strong> &ndash; learn more about its <a href="https://github.com/cue-lang/cue/releases/tag/v0.13.0">new features and improvements</a>
            </div>
            <a class="button button--outline notification-bar__cta" href="/docs/introduction/installation/">
                    <span class="button__text">Install CUE</span>
                    



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--download"></use>
</svg>

                </a>
            <button type="button" class="button button--icon button--small notification-bar__close">
                



<svg class="icon button__icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--close"></use>
</svg>

                <span class="button__text">Close</span>
            </button>
        </div>
    </div>

        
        

<div id="mobile-menu" class="drawer drawer--mobile" data-drawer="menu">
    <div class="drawer__backdrop" data-drawer-close="menu"></div>
    <div class="drawer__container" tabindex="0">
        <div class="drawer__header">
            <a href="/" class="drawer__branding" rel="home">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><path class="logo__letters" d="M39.555 50.355c-6.853.0-11.907 5.133-11.907 13.602s5.027 13.602 11.907 13.602c5.818.0 10.073-3.648 10.94-8.883l-4.034-.012c-.686 3.389-3.532 5.252-6.88 5.252-4.541.0-7.968-3.533-7.968-9.957s3.414-9.955 7.979-9.955c3.373.0 6.207 1.902 6.865 5.328l.004-.002h4.033c-.906-5.664-5.34-8.975-10.94-8.975zm38.748.362-.002.004h.002zm0 .004v26.478H96.07v-3.44H82.297v-8.105h12.752V62.23H82.297V54.16h13.617v-3.44zm-24.823.0v17.521c0 5.974 4.651 9.4 10.51 9.4 5.86.0 10.528-3.426 10.528-9.4V50.721h-3.995v17.457c0 3.711-2.985 5.793-6.529 5.793s-6.517-2.082-6.517-5.793V50.72z"/><path class="logo__inner" d="M64 9.586C33.947 9.586 9.586 33.947 9.586 64S33.947 118.414 64 118.414 118.414 94.053 118.414 64 94.05 9.586 64 9.586zm0 105.973c-28.476.0-51.562-23.086-51.562-51.562S35.524 12.438 64 12.438 115.562 35.524 115.562 64 92.476 115.562 64 115.562z"/><path class="logo__outer" d="M64 0C28.653.0.0 28.653.0 64s28.653 64 64 64 64-28.653 64-64S99.347.0 64 0zm0 121.843C32.054 121.843 6.157 95.946 6.157 64S32.054 6.157 64 6.157 121.843 32.054 121.843 64 95.946 121.843 64 121.843z"/></svg>
                <span>Homepage of CUE</span>
            </a>

            <div class="drawer__close">
                <button type="button" class="button button--white button--icon" data-drawer-close="menu">
                    



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--close"></use>
</svg>

                    <span class="button__text">Hide menu</span>
                </button>
            </div>
        </div>

        <div class="drawer__content">
            <div class="drawer__menu">
                <nav class="nav nav--mobile" aria-label="Mobile menu">
                    <ul class="nav__list">
                        
                            <li class="nav__item">
                                
                                <a class="nav__link"
                                   href="/docs/">
                                    <span class="nav__text">Documentation</span>
                                </a>
                            </li>
                        
                            <li class="nav__item">
                                
                                <a class="nav__link"
                                   href="/play/">
                                    <span class="nav__text">Play</span>
                                </a>
                            </li>
                        
                            <li class="nav__item">
                                
                                <a class="nav__link"
                                   href="/community/">
                                    <span class="nav__text">Community</span>
                                </a>
                            </li>
                        

                        
                            <li class="nav__item">
                                
                                <a class="nav__link"
                                   href="/docs/introduction/installation/">
                                    <span class="nav__text">Install</span>
                                </a>
                            </li>
                        

                        <li class="nav__item nav__item--search">





<div data-search-autocomplete="drawer"
     data-searchbar-size="small"
     data-searchbar-placeholder=""
>
    <div id="autocomplete-drawer"></div>
</div>
</li>
                    </ul>
                </nav>
            </div>
        </div>

        <div class="drawer__footer">
            <nav class="nav nav--social" aria-label="Social">
                <ul class="nav__list">
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="https://github.com/cue-lang/cue"target="_blank" >
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--github"></use>
</svg>

                                <span class="nav__text">GitHub</span>
                            </a>
                        </li>
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="/s/slack">
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--slack"></use>
</svg>

                                <span class="nav__text">Slack</span>
                            </a>
                        </li>
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="/s/discord">
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-discord"></use>
</svg>

                                <span class="nav__text">Discord</span>
                            </a>
                        </li>
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="https://twitter.com/cue_lang"target="_blank" >
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-x"></use>
</svg>

                                <span class="nav__text">X (Twitter)</span>
                            </a>
                        </li>
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="https://bsky.app/profile/cuelang.org"target="_blank" >
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-bluesky"></use>
</svg>

                                <span class="nav__text">Bluesky</span>
                            </a>
                        </li>
                    
                        <li class="nav__item">
                            
                            <a class="nav__link"
                               href="https://www.youtube.com/@cuelang/videos"target="_blank" >
                                



<svg class="icon" aria-hidden="true">
    <use xmlns:xlink="http://www.w3.org/1999/xlink"
         xlink:href="/img/ui.svg#icon--social-youtube"></use>
</svg>

                                <span class="nav__text">YouTube</span>
                            </a>
                        </li>
                    
                </ul>
            </nav>
        </div>
    </div>
</div>

        

    
    <script src="/js/main.min.f4174e980af6f5e0cedc0ce09a77d6f3a18405dee07c4cdd87543814539fabb3.js" integrity="sha256-9BdOmAr29eDO3AzgmnfW86GEBd7gfEzdh1Q4FFOfq7M=" async></script>






    </body>
</html>
