# Ensure that preprocessor understands how to handle multi-stage scripts.
# This includes formatting an upload node, running a script node, and
# skipping formatting a file in another upload node.

unquote content/dir/en.md golden/content/dir/en.md.writeBack

# Run the preprocessor
exec preprocessor execute --debug=all

cmp content/dir/gen_cache.cue golden/content/dir/gen_cache.cue

# Copy the resulting soure file sideways and use that in comparison
# so that we don't inadvertently update it when using CUE_UPDATE=1
cp content/dir/en.md content/dir/en.md.writeBack

# Verify that the source file is intact
cmp content/dir/en.md.writeBack golden/content/dir/en.md.writeBack

# Verify that the target files match the source contents
cmp hugo/content/en/dir/index.md golden/hugo/content/en/dir/index.md

# Re-run the preprocessor and ensure we have a cache hit
exec preprocessor execute --debug=all
stderr $WORK${/}'content'${/}'dir'${/}'en.md: cache hit for multi-step script; not running'

# Re-run the preprocessor again with --skipcache to ensure we re-run a cache hit
exec preprocessor execute --debug=all --skipcache
stderr $WORK${/}'content'${/}'dir'${/}'en.md: skipping cache for multi-step script; was a hit'

-- hugo/.keep --
-- content/site.cue --
package site
-- content/dir/page.cue --
package site

content: dir: page: {
	leftDelim:  "{{{"
	rightDelim: "}}}"

	sanitisers: [
		{
			kind:          "patternSanitiser"
			commandPrefix: "cue eval"
			pattern: expr: "member1"
			replacement: "member3"
		},
		{
			kind:    "patternSanitiser"
			command: "cue version"
			pattern: {
				expr: #"GOARCH .+$"#
				linewise: true
			}
			replacement: "GOARCH amd64"
		},
		{
			kind:    "patternSanitiser"
			command: "cue version"
			pattern: {
				expr: #"GOOS .+$"#
				linewise: true
			}
			replacement: "GOOS linux"
		},
	]
}
-- content/dir/en.md --
>---
>title: JSON Superset
>---
>{{{with step}}}
>{{{with upload "en" "upload-some-cue"}}}
>#codetab(in.cue) linenos="table"
>-- in.cue --
>// A doc comment
>map: {
>member1: 3 // a line comment
>member2: 4
>}
>{{{end}}}
>{{{with upload "en" "upload-some-json"}}}
>#nofmt(in.json)
>-- in.json --
>{
>"x": 5
>}
>{{{end}}}
>{{{with script "en" "run-the-cue"}}}
>cue eval in.cue # test
>{{{end}}}
>{{{with script "en" "cue version"}}}
>cue version
>{{{end}}}
>{{{end}}}
-- golden/content/dir/en.md.writeBack --
>---
>title: JSON Superset
>---
>{{{with step}}}
>{{{with upload "en" "upload-some-cue"}}}
>#codetab(in.cue) linenos="table"
>-- in.cue --
>// A doc comment
>map: {
>	member1: 3 // a line comment
>	member2: 4
>}
>{{{end}}}
>{{{with upload "en" "upload-some-json"}}}
>#nofmt(in.json)
>-- in.json --
>{
>"x": 5
>}
>{{{end}}}
>{{{with script "en" "run-the-cue"}}}
>cue eval in.cue # test
>{{{end}}}
>{{{with script "en" "cue version"}}}
>cue version
>{{{end}}}
>{{{end}}}
-- golden/hugo/content/en/dir/index.md --
---
title: JSON Superset
---
{{< step stepNumber="1" >}}
```cue { title="in.cue" linenos="table" }
// A doc comment
map: {
	member1: 3 // a line comment
	member2: 4
}
```
```json { title="in.json" }
{
"x": 5
}
```
```text { title="TERMINAL" codeToCopy="Y3VlIGV2YWwgaW4uY3VlICMgdGVzdAo=" }
$ cue eval in.cue # test
map: {
    member3: 3
    member2: 4
}
```
```text { title="TERMINAL" codeToCopy="Y3VlIHZlcnNpb24K" }
$ cue version
cue version v0.7.0

go version go1.21.1
      -buildmode exe
       -compiler gc
       -trimpath true
  DefaultGODEBUG panicnil=1
     CGO_ENABLED 0
          GOARCH amd64
            GOOS linux
```
{{< /step >}}
-- golden/content/dir/gen_cache.cue --
package site
{
	content: {
		dir: {
			page: {
				cache: {
					upload: {
						"upload-some-cue":  "6sIgD85tvVWnAz/m9bgsT9xpPP0L9K0Slu7l9jWt8S4="
						"upload-some-json": "bqidj/PlHulWSfpmY92pYl/dcV6Ngb+TCYXUuf/r2rA="
					}
					multi_step: {
						"1NDKKD8TVFVRJSP03N4KG7Q6MIR0EKTK9I6HU3IVQ41K0QHUNP80====": [{
							cmd:      "cue eval in.cue # test"
							exitCode: 0
							output: """
									map: {
									    member3: 3
									    member2: 4
									}

									"""
						}, {
							cmd:      "cue version"
							exitCode: 0
							output: """
									cue version v0.7.0

									go version go1.21.1
									      -buildmode exe
									       -compiler gc
									       -trimpath true
									  DefaultGODEBUG panicnil=1
									     CGO_ENABLED 0
									          GOARCH amd64
									            GOOS linux

									"""
						}]
					}
				}
			}
		}
	}
}
