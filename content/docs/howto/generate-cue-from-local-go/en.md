---
title: Generate CUE from a local Go code
toc_hide: true
tags:
    - cue command
---

{{{with _script_ "en" "set caches to speed up re-running"}}}
export GOMODCACHE=/caches/gomodcache
export GOCACHE=/caches/gobuild
{{{end}}}

{{{with step}}}
Create a Go module to hold our example:

{{{with script "en" "go mod init"}}}
go mod init mod.example
{{{end}}}

{{{end}}}

{{{with step}}}
Write a simple main program that loads JSON encoded config from `stdin`:

{{{with upload "en" "main.go"}}}
-- main.go --
package main

import (
	"encoding/json"
	"fmt"
	"log"
	"os"
)

type Config struct {
	Vals  []Val `json:"vals"`
	Level int   `json:"level"`
}

type Val struct {
	Name  string `json:"name"`
	Value string `json:"value"`
}

func main() {
	var cfg Config
	dec := json.NewDecoder(os.Stdin)
	if err := dec.Decode(&cfg); err != nil {
		log.Fatal(err)
	}

	fmt.Printf("Your config is level: %d\n", cfg.Level)
	fmt.Printf("It specifies %d vals\n", len(cfg.Vals))
	if len(cfg.Vals) > 0 {
		fmt.Printf("The first val is named %q\n", cfg.Vals[0].Name)
	}
}
{{{end}}}

{{{end}}}

{{{with step}}}
Write some sample configuration:

{{{with upload "en" "config.json"}}}
-- config.json --
{
    "level": 42,
    "vals": [
        {
            "name": "cueckoo",
            "value": "bird"
        },
        {
            "name": "porcuepine",
            "value": "animal"
        }
    ]
}
{{{end}}}

{{{end}}}

{{{with step}}}
Check that we can run our program passing in the sample configuration:

{{{with script "en" "initial test"}}}
go run . < config.json
{{{end}}}

{{{end}}}

{{{with step}}}
Create a CUE module to hold the CUE generated from the local Go types:

{{{with script "en" "cue mod init"}}}
cue mod init mod.example
{{{end}}}

{{{end}}}

{{{with step}}}
Generate CUE from the Go types in the `main` package:

{{{with script "en" "cue get go"}}}
cue get go --local .
{{{end}}}

{{{end}}}



{{{with _script_ "en" "backup generated cue"}}}
mv main_go_gen.cue .main_go_gen.cue
{{{end}}}

{{{with step}}}
Inspect the generated CUE code:

{{{with upload "en" "generated cue"}}}
-- main_go_gen.cue --
// Code generated by cue get go. DO NOT EDIT.

//cue:generate cue get go mod.example

package main

#Config: {
	vals: [...#Val] @go(Vals,[]Val)
	level: int @go(Level)
}

#Val: {
	name:  string @go(Name)
	value: string @go(Value)
}
{{{end}}}

{{{end}}}

{{{with _script_ "en" "ensure generated cue matches upload"}}}
diff main_go_gen.cue .main_go_gen.cue
{{{end}}}

{{{with step}}}
Use `cue vet` to validate our sample config file:

{{{with script "en" "vet config using CUE"}}}
cue vet -d '#Config' . config.json
{{{end}}}

{{{end}}}
