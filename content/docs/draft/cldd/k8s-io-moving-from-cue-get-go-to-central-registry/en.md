---
title: Migrating to the Central Registry's curated Kubernetes Schemas
draft: true
no_index: true
---

{{{with _script_ "en" "HIDDEN: setup"}}}
# Caches.
export GOMODCACHE=/caches/gomodcache
export GOCACHE=/caches/gobuild

# Registry access.
mkdir -p $HOME/.config/cue
cat <<EOD > $HOME/.config/cue/logins.json
{"registries":{"registry.cue.works":{"access_token":"${TEST_USER_AUTHN_CUE_USER_NEW}","token_type":"Bearer"}}}
EOD

# Switch to CUE tip, as this page will only be seen on tip.cuelang.org
# and it's easiest to align behaviours here, inline, rather than using
# the internal/patch/tip.diff mechanism.
export PATH=/cues/$CUELANG_CUE_TIP:$PATH
{{{end}}}

If you're already using CUE to validate or generate Kubernetes manifests then
you probably used the `cue get go` command to create the relevant packages and
schemas:

{{{with _script_ "en" "HIDDEN: cue get go setup"}}}
cue mod init kube.example
#ellipsis 0
go mod init kube.example
#ellipsis 0
go get k8s.io/api
#ellipsis 0
go get k8s.io/apimachinery
{{{end}}}
{{{with script "en" "cue get go"}}}
cue get go k8s.io/api/apps/v1
{{{end}}}

This command generates and stores CUE schemas under `cue.mod/gen/k8s.io/` after
you've also fetched the relevant Go source code.

The CUE
[Central Registry](https://registry.cue.works)
provides a well-known location for well-known modules
and schemas, including those from the Kubernetes project.
You can easily modify your CUE to rely on up-to-date, curated schemas published on the
[Central Registry](https://registry.cue.works)
by using the
[`cue refactor imports`](https://cuelang.org/docs/reference/command/cue-help-refactor-imports/)
command. This guide shows you how.

The `cue refactor imports` command is not yet available in the latest CUE release.
To use the command,
[install](https://cuelang.org/docs/introduction/installation/#download-an-official-cue-binary)
the most recent CUE prerelease. This page demonstrates the following version of CUE:

{{{with script "en" "cue version"}}}
#ellipsis 1
cue version
{{{end}}}

## Check your current CUE
Having schemas generated by `cue get go` has allowed you to validate Kubernetes
manifests, or to generate them from CUE code like this:
{{{with upload "en" "manifest pre"}}}
-- manifest.cue --
package kube

import apps "k8s.io/api/apps/v1"

apps.#Deployment & {
	apiVersion: "apps/v1"
	kind:       "Deployment"
	metadata: {
		labels: app: "example1"
		name: "example1"
	}
	spec: {
		replicas: 1
		selector: matchLabels: app: "example1"
		template: {
			metadata: labels: app: "example1"
			spec: containers: [{
				image: "nginx:latest"
				name:  "nginx"
			}]
		}
	}
}
{{{end}}}
The `import` line, at the top of this CUE file, specifies the location of the
schemas previously generated from the Kubernetes source code.
These schemas allow the `cue vet` command to catch validation problems in our
manifest:
{{{with script "en" "vet pre"}}}
cue vet -c
{{{end}}}
Because `cue vet` doesn't print any errors, we know that the manifest currently
validates successfully.

## Authenticate to the Central Registry
You need to be authenticated to the
[Central Registry](https://registry.cue.works)
-- so if you haven't
done so previously you'll need to login:
{{{with script "en" "cue login"}}}
#norun
cue login
{{{end}}}
This allows you to fetch the curated Kubernetes module, which contains the curated schemas.

## Update your CUE files
To update the relevant imports across every CUE file in your module, run the
[`cue refactor imports`](https://cuelang.org/docs/reference/command/cue-help-refactor-imports/)
command with a "before" and "after" prefix.
In the case of Kubernetes schemas, this is the command you need to run:

{{{with script "en" "refactor"}}}
cue refactor imports k8s.io test.cue.works/x1/k8s.io
{{{end}}}

CUE files are re-written, updating `import` lines as required:
{{{with _script_ "en" "HIDDEN: move manifest"}}}
mv manifest.cue .manifest.cue
{{{end}}}
{{{with upload "en" "manifest post"}}}
-- manifest.cue --
package kube

import apps "test.cue.works/x1/k8s.io/api/apps/v1"

apps.#Deployment & {
	apiVersion: "apps/v1"
	kind:       "Deployment"
	metadata: {
		labels: app: "example1"
		name: "example1"
	}
	spec: {
		replicas: 1
		selector: matchLabels: app: "example1"
		template: {
			metadata: labels: app: "example1"
			spec: containers: [{
				image: "nginx:latest"
				name:  "nginx"
			}]
		}
	}
}
{{{end}}}
{{{with _script_ "en" "HIDDEN: diff manifest"}}}
diff manifest.cue .manifest.cue
{{{end}}}

The `import` line at the top now references the appropriate curated module for
the deployment contained in the manifest. Its path is currently temporary, but
only while its proper location is being decided. The temporary path isn’t a
problem because one important property of the
[Central Registry](https://registry.cue.works)
is that, once a schema is published, it will always be available at that
location. When the curated module’s location is finalised and versions are
published under the new path, you can easily use the `cue refactor imports`
command to update your CUE again!

## Tidy your CUE module
{{{with _script_ "en" "HIDDEN: fetch a static version so cue.mod/module.cue content, below, is stable"}}}
cue mod get test.cue.works/x1/k8s.io@v0.3.0
{{{end}}}
{{{with script "en" "cue mod tidy"}}}
cue mod tidy
{{{end}}}
Tidying your CUE module fetches the Kubernetes module from the
[Central Registry](https://registry.cue.works),
and updates the `cue.mod/module.cue` file to track this dependency:

{{{with script "en" "display module.cue"}}}
cat cue.mod/module.cue
{{{end}}}

Updating to a later version of a curated module is performed by a different
command (not `cue refactor imports`) -- we'll be publishing a guide about how
to do that, soon!

## Remove the old packages and schemas
The schemas stored in the `cue.mod/gen/k8s.io/` directory are no longer needed,
and should be deleted:
{{{with script "en" "rm cue.mod/gen/k8s.io"}}}
rm -r cue.mod/gen/k8s.io/
{{{end}}}

## Check your updated CUE
{{{with script "en" "vet post"}}}
cue vet -c
{{{end}}}
Because `cue vet` doesn't print any errors, we know that the manifest still
validates successfully against the new schemas.
